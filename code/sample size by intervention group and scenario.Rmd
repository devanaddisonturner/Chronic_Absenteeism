---
title: "Quantifying the Impact of Building Energy Efficiency Retrofits and Nature Exposure on Human Health and Well-Being"
author: "Devan Cantrell Addison-Turner, Yingjie Li, Anthony Dylan Kinslow II, Gretchen Cara Daily, and Rishee Kumar Jain"
date: "2024-06-27"
output: html_document
editor_options: 
  chunk_output_type: inline
---


# Setup
```{r}

### To clear your environment
remove(list = ls())

#Get working directory and file path information, then set for working environment in the current R session.
getwd()
# setwd('path')
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


## Packages --------------------------------------------------------------------
# install.packages("readr", dependencies = TRUE)
# install.packages("readxl", dependencies = TRUE)

### --- viz ----
# install.packages("ggplot2")
library(ggplot2)
#install.packages("viridis")
# install.packages("tidyverse", dependencies = TRUE)
# install.packages("dplyr", dependencies = TRUE)

library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
library(viridis)

### --- to impute data ----
# install.packages("devtools")
# install.packages("lattice")
# install.packages("VIM")
library(lattice)
library(VIM) ## aggr()


#Run the following lines twice to complete install of the mice package. This archived version of the MICE package is not compatible with Mac0S. Instead, use Windows operating system.
library(devtools)
#install_version("mice", version = "3.11.0", repos = "https://cloud.r-project.org")
library(mice)

### ---- Matching ----
#install.packages("MatchIt")
#install.packages("optmatch")
##Note: MatchIt package may not install or load on MacOS. Instead, use Windows OS.

library(MatchIt)
```


# Treatment Analysis for 3 Policy Interventions in K-12 schools 

## EE - comb 1
```{r}
# Total number of Treatments for K-12 Schools in each policy intervention/scenario

#Read individual data file to obtain the total counts of treatments across each scenario and interventions 
#including subset of EE retrofit
#for the following variables (i) retrofit, (ii) ndvi_median_binary, (iii) retrofit_and_ndvi

#Group by the unique Unique County, District, School Code (CDS Code)

#Complete Dataset with All Energy Efficiency Retrofits in K-12 schools
Treatment_Count_Data_All <- read_csv("./data/Treatment_Count_Data_All_coord.csv", show_col_types = F)

# Total Number of K-Schools analyzed by the Unique County, District, School Code (CDS Code)
length(unique(Treatment_Count_Data_All$CDSCode))


#calculate total number of interventions in each scenario by the unique K-12 school
treatment_count_by_scenario <- Treatment_Count_Data_All %>% 
  select(retrofit, ndvi_median_binary, retrofit_and_ndvi) %>% 
  summarise_if(is.numeric, list(sum = ~sum(., na.rm = TRUE)))


## Subset Data by 4 types of Energy Efficiency Retrofits

#1. Lighting 
#2. HVAC
#3. Building Envelope
#4. Pumps, Motors, & Drives
```


### with Scenario
```{r}
treatment_count_byScenario_byRetrofitType <- Treatment_Count_Data_All %>% 
  select(EE_Retrofit_Type, retrofit, ndvi_median_binary, retrofit_and_ndvi) %>% 
  pivot_longer(cols = 2:ncol(.), names_to = 'Scenario') %>%
  group_by(EE_Retrofit_Type, Scenario, value) %>% 
  count() %>%
  mutate(treatment_control = ifelse(value==1, 'T', 'C'),
         treatment_control = as.factor(treatment_control),
         Scenario = factor(Scenario, 
                           levels = c("retrofit", 
                                      "ndvi_median_binary", 
                                      "retrofit_and_ndvi"), 
                           labels = c( 'Scenario 1: EE Retrofit', 
                                       'Scenario 2: Nature Exposure',
                                       'Scenario 3: EE Retrofit and Nature Exposure'))
         ) %>%
  mutate(Type = paste0(EE_Retrofit_Type, ' - ', treatment_control)) %>%
  as.data.frame()

# str(treatment_count_byScenario_byRetrofitType)
```



```{r}
## plot
treatment_count_byScenario_byRetrofitType %>%
  filter(!is.na(EE_Retrofit_Type)) %>%
  ggplot(., aes(fill = Scenario, x = Type, y = n)) +
  geom_bar(
    aes(
      # color = treatment_control,
      alpha = treatment_control),
    position = "stack",
    stat = "identity") +
  # scale_color_manual(values = c('white', 'black')) +
  scale_alpha_manual(values = c(.5, 1)) +
  guides(alpha = "none") +
  # Add text labels
  geom_text(aes(label = ifelse(n >= 60, n, "")),
            position = position_stack(vjust = 0.5), # Center labels in the stack
            color = "black") +                     # Change label color to white
  labs(x = "Energy Efficiency Retrofit", y = "Number of K-12 Schools", title = "Intervention Groups in California, USA K-12 Schools") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = c(.7,.15)) +
  # scale_fill_discrete(labels=c('Scenario 2: Nature Exposure', 'Scenario 1: EE Retrofit', 'Scenario 3: EE Retrofit and Nature Exposure')) +
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title

f <- paste0('./figures/', 'treatment_count_comb1.png')
ggsave(filename = f, plot = last_plot(), width = 7, height = 5, units = "in", dpi = 300)

```



### without Scenario
```{r}
treatment_count_noScenario_byRetrofitType <- Treatment_Count_Data_All %>% 
  select(EE_Retrofit_Type, retrofit, ndvi_median_binary, retrofit_and_ndvi) %>% 
  pivot_longer(cols = 2:ncol(.), names_to = 'Scenario') %>%
  group_by(EE_Retrofit_Type, value) %>% 
  count() %>%
  mutate(treatment_control = ifelse(value==1, 'T', 'C'),
         treatment_control = as.factor(treatment_control)
         ) %>%
  mutate(Type = paste0(EE_Retrofit_Type, ' - ', treatment_control)) %>%
  as.data.frame()
```



```{r}
## plot
treatment_count_noScenario_byRetrofitType %>%
  filter(!is.na(EE_Retrofit_Type)) %>%
  ggplot(., aes(x = Type, y = n)) +
  geom_bar(
    aes(
      alpha = treatment_control),
    position = "stack",
    stat = "identity") +
  # scale_color_manual(values = c('white', 'black')) +
  scale_alpha_manual(values = c(.5, 1)) +
  guides(alpha = "none") +
  # Add text labels
  geom_text(aes(label = ifelse(n >= 60, n, "")),
            position = position_stack(vjust = 0.5), # Center labels in the stack
            color = "black") +                     # Change label color to white
  labs(x = "Energy Efficiency Retrofit", 
       y = "Number of K-12 Schools", 
       title = "Intervention Groups in California, USA K-12 Schools") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = c(.7,.15)) +
  # scale_fill_discrete(labels=c('Scenario 2: Nature Exposure', 'Scenario 1: EE Retrofit', 'Scenario 3: EE Retrofit and Nature Exposure')) +
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title

f <- paste0('./figures/', 'treatment_count_comb1_noScenario.png')
ggsave(filename = f, plot = last_plot(), width = 7, height = 5, units = "in", dpi = 300)
```



## EE - comb 2

```{r}
comb <- treatment_count_byScenario_byRetrofitType %>%
  filter(!is.na(EE_Retrofit_Type)) %>%
  as.data.frame()

# Get all unique 2-type combinations
type_pairs <- combn(unique(comb$EE_Retrofit_Type), 2, simplify = FALSE)

# Calculate total count for each pair and feature
library(purrr)

comb2 <- map_dfr(type_pairs, ~ {
  comb %>%
    filter(EE_Retrofit_Type %in% .x) %>%           # Keep rows with the current pair of types
    group_by(Scenario, treatment_control) %>%              # Group by feature
    summarise(n = sum(n, na.rm = T)) %>%  # Sum count for the group
    mutate(combination = paste(.x, collapse = " & "))  # Add combination label
}) %>%
  as.data.frame() %>%
  mutate(Type = paste0(combination, ' - ', treatment_control))
```


```{r}

comb2 %>%
  ggplot(., aes(fill = Scenario, x = Type, y = n)) +
  geom_bar(
    aes(
      # color = treatment_control,
      alpha = treatment_control),
    position = "stack",
    stat = "identity") +
  # scale_color_manual(values = c('white', 'black')) +
  scale_alpha_manual(values = c(.5, 1)) +
  guides(alpha = "none") +
  # Add text labels
  geom_text(aes(label = ifelse(n >= 60, n, "")),
            position = position_stack(vjust = 0.5), # Center labels in the stack
            color = "black") +                     # Change label color to white
  labs(x = "Energy Efficiency Retrofit", y = "Number of K-12 Schools", title = "Intervention Groups in California, USA K-12 Schools") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = c(0.7, 0.08), 
        legend.key.height= unit(0.5, 'cm'),
        legend.key.width= unit(0.5, 'cm'),
        legend.background=element_blank()) +
  # scale_fill_discrete(labels=c('Scenario 2: Nature Exposure', 'Scenario 1: EE Retrofit', 'Scenario 3: EE Retrofit and Nature Exposure')) +
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title

f <- paste0('./figures/', 'treatment_count_comb2.png')
ggsave(filename = f, plot = last_plot(), width = 8, height = 6, units = "in", dpi = 300)
```



## EE - comb 3

```{r}

# Get all unique 2-type combinations
type_pairs <- combn(unique(comb$EE_Retrofit_Type), 3, simplify = FALSE)

# Calculate total count for each pair and feature
comb3 <- map_dfr(type_pairs, ~ {
  comb %>%
    filter(EE_Retrofit_Type %in% .x) %>%           # Keep rows with the current pair of types
    group_by(Scenario, treatment_control) %>%              # Group by feature
    summarise(n = sum(n, na.rm = T)) %>%  # Sum count for the group
    mutate(combination = paste(.x, collapse = " & "))  # Add combination label
}) %>%
  as.data.frame() %>%
  mutate(Type = paste0(combination, ' - ', treatment_control))
```


```{r}

comb3 %>%
  ggplot(., aes(fill = Scenario, x = Type, y = n)) +
  geom_bar(
    aes(
      # color = treatment_control,
      alpha = treatment_control),
    position = "stack",
    stat = "identity") +
  # scale_color_manual(values = c('white', 'black')) +
  scale_alpha_manual(values = c(.5, 1)) +
  guides(alpha = "none") +
  # Add text labels
  geom_text(aes(label = ifelse(n >= 60, n, "")),
            position = position_stack(vjust = 0.5), # Center labels in the stack
            color = "black") +                     # Change label color to white
  labs(x = "Energy Efficiency Retrofit", y = "Number of K-12 Schools", title = "Intervention Groups in California, USA K-12 Schools") +
  coord_flip() +
  theme_bw() +
  theme(legend.position = c(0.7, 0.4), 
        legend.key.height= unit(0.5, 'cm'),
        legend.key.width= unit(0.5, 'cm'),
        legend.background=element_blank()) +
  # scale_fill_discrete(labels=c('Scenario 2: Nature Exposure', 'Scenario 1: EE Retrofit', 'Scenario 3: EE Retrofit and Nature Exposure')) +
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title

f <- paste0('./figures/', 'treatment_count_comb3.png')
ggsave(filename = f, plot = last_plot(), width = 8.5, height = 6, units = "in", dpi = 300)
```




## EE - comb 4

```{r}

# Get all unique 2-type combinations
type_pairs <- combn(unique(comb$EE_Retrofit_Type), 4, simplify = FALSE)

# Calculate total count for each pair and feature
comb4 <- map_dfr(type_pairs, ~ {
  comb %>%
    filter(EE_Retrofit_Type %in% .x) %>%           # Keep rows with the current pair of types
    group_by(Scenario, treatment_control) %>%              # Group by feature
    summarise(n = sum(n, na.rm = T)) %>%  # Sum count for the group
    mutate(combination = paste(.x, collapse = " & "))  # Add combination label
}) %>%
  as.data.frame() %>%
  mutate(Type = paste0('All 4 types of EE Retrofits', ' - ', treatment_control))
```


```{r}

comb4 %>%
  ggplot(., aes(fill = Scenario, x = Type, y = n)) +
  geom_bar(
    aes(
      alpha = treatment_control),
      position = "stack",
      stat = "identity") +
  # scale_color_manual(values = c('white', 'black')) +
  scale_alpha_manual(values = c(.5, 1)) +
  guides(alpha = "none") +
  # Add text labels
  geom_text(aes(label = ifelse(n >= 60, n, "")),
            position = position_stack(vjust = 0.5), # Center labels in the stack
            color = "black") +                     # Change label color to white
  labs(x = "Energy Efficiency Retrofit", y = "Number of K-12 Schools", title = "Intervention Groups in California, USA K-12 Schools") +
  coord_flip() +
  theme_bw() +
  scale_x_discrete(expand = expansion(mult = c(1.5, 0.6))) +  # Add 150% space at the bottom
  # scale_x_discrete(expand = c(2, 0)) +  # Add 10% space at the top
  theme(legend.position = c(0.7, 0.15), 
        legend.key.height= unit(0.5, 'cm'),
        legend.key.width= unit(0.5, 'cm'),
        legend.background=element_blank()) +
  # scale_fill_discrete(labels=c('Scenario 2: Nature Exposure', 'Scenario 1: EE Retrofit', 'Scenario 3: EE Retrofit and Nature Exposure')) +
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title

f <- paste0('./figures/', 'treatment_count_comb4.png')
ggsave(filename = f, plot = last_plot(), width = 8, height = 4, units = "in", dpi = 300)
```
