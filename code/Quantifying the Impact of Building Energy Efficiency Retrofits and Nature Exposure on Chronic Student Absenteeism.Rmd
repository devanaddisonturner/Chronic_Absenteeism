---
title: "Quantifying the Impact of Building Energy Efficiency Retrofits and Nature Exposure on Chronic Student Absenteeism"
author: "Devan Cantrell Addison-Turner, Yingjie Li, Rishee Kumar Jain, and Gretchen Cara Daily"
date: "2024-06-27"
output: html_document
editor_options: 
  chunk_output_type: inline
---


# Setup
```{r}
#Get working directory and file path information, then set for working environment in the current R session.
getwd()
# setwd('path')
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


## Packages --------------------------------------------------------------------
# install.packages("readr", dependencies = TRUE)
# install.packages("readxl", dependencies = TRUE)

### --- viz ----
# install.packages("ggplot2")
library(ggplot2)
#install.packages("viridis")
# install.packages("tidyverse", dependencies = TRUE)
# install.packages("dplyr", dependencies = TRUE)
# install.packages('mapdata')
# install.packages('terra', repos='https://rspatial.r-universe.dev')
#update.packages(oldPkgs='terra')
library(terra)
#install.packages('mapview')
#install.packages("Rcpp")
library(Rcpp)
#install.packages("sf")
#install.packages('rgdal_xxx.tar.gz', repos = NULL, type = 'source')
library(rgdal)
#options("install.lock"=FALSE)
library(sf)
#install.packages("sf", dependencies=TRUE)
#install.packages('maps')
#install.packages('terrain')
#install.packages('ggspatial')
#install.packages('ggmap')
#install.packages('maptiles')
#installl.packages('tidyterra')
#install.packages('OpenStreetMap')

library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
library(viridis)
library(ggplot2)
library(mapdata)
library(maps)
library(terra)
library(mapview)
library(sf)
library(leaflet)
library(webshot)
library(ggspatial)
library(ggmap)
library(maptiles)
library(tidyterra)
library(tidyverse)
library(OpenStreetMap)

### --- to impute data ----
# install.packages("devtools")
# install.packages("lattice")
# install.packages("VIM")
library(lattice)
library(VIM) ## aggr()


#Run the following lines twice to complete install of the mice package. This archived version of the MICE package is not compatible with Mac0S. Instead, use Windows operating system.
library(devtools)
#install_version("mice", version = "3.11.0", repos = "https://cloud.r-project.org")
library(mice)

### ---- Matching ----
#install.packages("MatchIt")
#install.packages("optmatch")
##Note: MatchIt package may not install or load on MacOS. Instead, use Windows OS.

library(MatchIt)
```

# Data

## Input data

### Raw data 

 Examine if inequalities exist in K-12 Schools across California, USA from 2020-2022 in context of the COVID-19 Pandemic
 
```{r}
# library(ggplot2)
# library(viridis)
# library(readr)
# library(readxl)

CASchools_Data_income_subset <- read_csv("./data/CASchools_Data_income_subset.csv")

CASchools_Data_income_subset$income_f = factor(CASchools_Data_income_subset$income, levels=c('high income','medium income','low income'))

ggplot(CASchools_Data_income_subset, aes(x = Year_built, y = Chronic_Absenteeism, color =  Diversity_Index, alpha = 0.5)) + 
#geom specifies the type of graph points to be displayed
  geom_point() + scale_color_viridis() + theme_bw() +
  facet_grid(School_Type ~ income_f) + xlim(1850, 2022) + ylim(0, 100) + 
labs(x = "Year Built of K-12 Schools", 
       y = "Chronic Absenteeism Rate (%)", 
       title ="Year Built and Chronic Absenteeism in California, USA K-12 Schools") + 
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = './figures/', 'YearBuilt_ChronicAbsenteeism_SEProfile.png', plot = last_plot(), width = 9, height = 6, units = "in", dpi = 300)


ggplot(CASchools_Data_income_subset, aes(x = Pollution_Burden, y = Chronic_Absenteeism, color =  Diversity_Index, alpha = 0.5)) + 
#geom specifies the type of graph points to be displayed
  geom_point() + scale_color_viridis() + theme_bw() +
  facet_grid(School_Type ~ income_f) + xlim(0, 100) + ylim(0, 100) + 
labs(x = "Pollution Burden (%)", 
       y = "Chronic Absenteeism Rate (%)", 
       title ="Pollution Burden and Chronic Absenteeism in California, USA K-12 Schools") + 
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = './figures/', 'Pollution_ChronicAbsenteeism_SEProfile.png', plot = last_plot(), width = 9, height = 6, units = "in", dpi = 300)

ggplot(CASchools_Data_income_subset, aes(x = COVID_infections, y = Chronic_Absenteeism, color =  Diversity_Index, alpha = 0.5)) + 
#geom specifies the type of graph points to be displayed
  geom_point() + scale_color_viridis() + theme_bw() +
  facet_grid(School_Type ~ income_f) + xlim(0, 100) + ylim(0, 100) + 
labs(x = "COVID-19 Infections Rate (%)", 
       y = "Chronic Absenteeism Rate (%)", 
       title ="COVID-19 and Chronic Absenteeism in California, USA K-12 Schools") + 
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = './figures/', 'COVID19_ChronicAbsenteeism_SEProfile.png', plot = last_plot(), width = 9, height = 6, units = "in", dpi = 300)

ggplot(CASchools_Data_income_subset, aes(x = NDVI_median, y = Chronic_Absenteeism, color =  Diversity_Index, alpha = 0.5)) + 
#geom specifies the type of graph points to be displayed
  geom_point() + scale_color_viridis() + theme_bw() +
  facet_grid(School_Type ~ income_f) + xlim(-1, 1) + ylim(0, 100) + 
labs(x = "Normalized Difference Vegetation Index", 
       y = "Chronic Absenteeism Rate (%)", 
       title ="NDVI and Chronic Absenteeism in California, USA K-12 Schools") + 
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = './figures/', 'NDVI_ChronicAbsenteeism_SEProfile.png', plot = last_plot(), width = 9, height = 6, units = "in", dpi = 300)

ggplot(CASchools_Data_income_subset, aes(x = Land_Surface_Temp, y = Chronic_Absenteeism, color =  Diversity_Index, alpha = 0.5)) + 
#geom specifies the type of graph points to be displayed
  geom_point() + scale_color_viridis() + theme_bw() +
  facet_grid(School_Type ~ income_f) + xlim(0, 100) + ylim(0, 100) + 
labs(x = "Land Surface Temperature (Â°C)", 
       y = "Chronic Absenteeism Rate (%)", 
       title ="Land Surface Temperature and Chronic Absenteeism in California, USA K-12 Schools") + 
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = './figures/', 'LST_ChronicAbsenteeism_SEProfile.png', plot = last_plot(), width = 9, height = 6, units = "in", dpi = 300)
```


 California, USA K-12 Schools Raw Dataset to simulate 3 interventions effects on Chronic Absenteeism during the COVID-19 Pandemic

```{r  Overall Data}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)

CASchools_PSM_Data <- read_csv("./data/ChronicAbsenteeism_Schools_PSM_Data.csv", show_col_types = F)

#changing variable to numeric for the Overall Dataset
CASchools_PSM_Data2 <- CASchools_PSM_Data %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_Disabilities = as.numeric(Students_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -Percent_LandCoverTotal,
                -Diversity_Index,
                -NDVI_median,
                -Student_Staff_Ratio,
                -StudentEnrollment_mean,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```

```{r   Subset Data}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
CASchools_PSM_Datacomplete <- read_csv("./data/CA_Schools_PSM_Datacomplete2.csv")

#changing variable to numeric for the Overall Dataset
CASchools_PSM_Datacomplete2 <- CASchools_PSM_Datacomplete %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water),
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff),
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```

Subset Data by 4 types of Energy Efficiency Retrofits
```{r}

#Single EE Retrofit Sub-System
CASchools_PSM_Data_subL <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting")
CASchools_PSM_Data_subH <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "HVAC")
CASchools_PSM_Data_subB <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Building_Envelope")
CASchools_PSM_Data_subP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Pumps_Motors_Drives")


#Dual EE Retrofit Sub-System
CASchools_PSM_Data_subLH <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting" | EE_Retrofit_Type == "HVAC")
CASchools_PSM_Data_subLB <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting" | EE_Retrofit_Type == "Building_Envelope")
CASchools_PSM_Data_subLP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting" | EE_Retrofit_Type == "Pumps_Motors_Drives")
CASchools_PSM_Data_subHB <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "HVAC" | EE_Retrofit_Type == "Building_Envelope")
CASchools_PSM_Data_subHP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "HVAC" | EE_Retrofit_Type == "Pumps_Motors_Drives")
CASchools_PSM_Data_subBP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Building_Envelope" | EE_Retrofit_Type == "Pumps_Motors_Drives")


#Triple EE Retrofit SUb-System
CASchools_PSM_Data_subLHB <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting" | EE_Retrofit_Type == "HVAC" | EE_Retrofit_Type == "Building_Envelope")
CASchools_PSM_Data_subLHP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting" | EE_Retrofit_Type == "HVAC" | EE_Retrofit_Type == "Pumps_Motors_Drives")
CASchools_PSM_Data_subHBP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "HVAC" | EE_Retrofit_Type == "Building_Envelope" | EE_Retrofit_Type == "Pumps_Motors_Drives")
CASchools_PSM_Data_subBLP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Building_Envelope" | EE_Retrofit_Type == "Lighting | EE_Retrofit_Type == Pumps_Motors_Drives")

```


##Single EE Retrofit
```{r}
# 1. EE Retrofit = Lighting 
#changing variable to numeric with subset data
CASchools_PSM_Data_subL2 <- CASchools_PSM_Data_subL %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#2. EE Retrofit = HVAC
#changing variable to numeric with subset data
CASchools_PSM_Data_subH2 <- CASchools_PSM_Data_subH %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#3. EE Retrofit = Building Envelope 

#changing variable to numeric with subset data
CASchools_PSM_Data_subB2 <- CASchools_PSM_Data_subB %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#4. EE Retrofit = Pumps, Motors, & Drives

#changing variable to numeric with subset data
CASchools_PSM_Data_subP2 <- CASchools_PSM_Data_subP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')

```


## Dual EE Retrofit
```{r}
#5. EE Retrofit = Lighting + HVAC
#changing variable to numeric with subset data
CASchools_PSM_Data_subLH2 <- CASchools_PSM_Data_subLH %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#6. EE Retrofit = Lighting + Building Envelope
#changing variable to numeric with subset data
CASchools_PSM_Data_subLB2 <- CASchools_PSM_Data_subLB %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#7.EE Retrofit = Lighting + Pumps, Motors, & Drives

#changing variable to numeric with subset data
CASchools_PSM_Data_subLP2 <- CASchools_PSM_Data_subLP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#8.EE Retrofit = HVAC + Building Envelope

#changing variable to numeric with subset data
CASchools_PSM_Data_subHB2 <- CASchools_PSM_Data_subHB %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')

#9. EE Retrofit = HVAC + Pumps, Motors, & Drives
#changing variable to numeric with subset data
CASchools_PSM_Data_subHP2 <- CASchools_PSM_Data_subHP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#10. EE Retrofit = Building Envelope + Pumps, Motors, & Drives
#changing variable to numeric with subset data
CASchools_PSM_Data_subBP2 <- CASchools_PSM_Data_subBP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```


## Triple EE Retrofit
```{r}
#11. EE Retrofit = Lighting + HVAC + Building Envelope
#changing variable to numeric with subset data
CASchools_PSM_Data_subLHB2 <- CASchools_PSM_Data_subLHB %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#12. EE Retrofit = Lighting + HVAC + Pumps, Motors, & Drives
#changing variable to numeric with subset data
CASchools_PSM_Data_subLHP2 <- CASchools_PSM_Data_subLHP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#13.EE Retrofit = HVAC + Building Envelope + Pumps, Motors, & Drives

#changing variable to numeric with subset data
CASchools_PSM_Data_subHBP2 <- CASchools_PSM_Data_subHBP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#14.EE Retrofit = Building Envelope + Lighting + Pumps, Motors, & Drives

#changing variable to numeric with subset data
CASchools_PSM_Data_subBLP2 <- CASchools_PSM_Data_subBLP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                # -CDS_Code,
                # -char_prem_id,
                # -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```



## Impute data and plot

  All multiple imputation techniques start with the MAR assumption (Missing at Random). 

  https://library.virginia.edu/data/articles/getting-started-with-multiple-imputation-in-r

```{r}
library(lattice)
library(VIM)
library(mice)
# Visualize Proportion of missing data
f <- paste0('./figures/', 'data_missing.png'); print(f)
png(filename = f, width = 7, height = 5, units = "in", res = 300)
cex.axis.size = 0.425
aggr(CASchools_PSM_Data2, cex.axis=cex.axis.size)
dev.off()

#Number of rows that would not be removed due to missing data
nrow(na.omit(CASchools_PSM_Data2))

# Multivariate Imputation by Chained-Equations (MICE)
#fill missing values in dataset by prediction through multiple iterations using
#the MICE algorithm
set.seed(27)
CASchools_PSM_Dataimp <- mice(CASchools_PSM_Data2, seed = 27)

# Complete dataset after imputation and store as a new dataframe
CASchools_PSM_Datacomplete_og <- complete(CASchools_PSM_Dataimp)


#Visualize Proportion of missing data in Imputed Dataset
f <- paste0('./figures/', 'data_missing_Imputed.png'); print(f)
png(filename = f, width = 7, height = 5, units = "in", res = 300)
aggr(CASchools_PSM_Datacomplete_og, cex.axis=cex.axis.size)
dev.off()

#Number of rows that would not be removed due to missing data
nrow(na.omit(CASchools_PSM_Datacomplete_og))

```

### Data Normalization
```{r  Overall Data}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

maxmin_scalar <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin <- as.data.frame(lapply(CASchools_PSM_Data2, maxmin_scalar))

scaling_maxmin$School_ID <- rownames(CASchools_PSM_Data2)

scaling_maxmin_dropna <- scaling_maxmin %>%
  tidyr::drop_na()

######### Imputed Dataset

maxmin_scalar_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_complete <- as.data.frame(lapply(CASchools_PSM_Datacomplete2, maxmin_scalar_complete))

scaling_maxmin_complete$School_ID <- rownames(CASchools_PSM_Datacomplete2)
```

```{r  EE Retrofit =  1. Lighting}

######### Imputed Dataset

maxmin_scalar_L_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_L_complete <- as.data.frame(lapply(CASchools_PSM_Data_subL2, maxmin_scalar_L_complete))

scaling_maxmin_L_complete$School_ID <- rownames(CASchools_PSM_Data_subL2)
```

```{r EE Retrofit =  2. HVAC}

######### Imputed Dataset

maxmin_scalar_H_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_H_complete <- as.data.frame(lapply(CASchools_PSM_Data_subH2, maxmin_scalar_H_complete))

scaling_maxmin_H_complete$School_ID <- rownames(CASchools_PSM_Data_subH2)
```

```{r  EE Retrofit = 3. Building Envelope}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_B_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_B_complete <- as.data.frame(lapply(CASchools_PSM_Data_subB2, maxmin_scalar_B_complete))

scaling_maxmin_B_complete$School_ID <- rownames(CASchools_PSM_Data_subB2)  

scaling_maxmin_B_complete$Percent_Forest[scaling_maxmin_B_complete$Percent_Forest] <- 0

scaling_maxmin_B_complete$Percent_Forest[which(scaling_maxmin_B_complete$Percent_Forest == "NaN")] = 0.0000000
```

```{r EE Retrofit = 4. Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_P_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_P_complete <- as.data.frame(lapply(CASchools_PSM_Data_subP2, maxmin_scalar_P_complete))
scaling_maxmin_P_complete$School_ID <- rownames(CASchools_PSM_Data_subP2)  
```


```{r  EE Retrofit = 5. Lighting + HVAC}

######### Imputed Dataset

maxmin_scalar_LH_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_LH_complete <- as.data.frame(lapply(CASchools_PSM_Data_subLH2, maxmin_scalar_LH_complete))

scaling_maxmin_LH_complete$School_ID <- rownames(CASchools_PSM_Data_subLH2)
```


```{r  EE Retrofit = 6. Lighting + Building Envelope}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_LB_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_LB_complete <- as.data.frame(lapply(CASchools_PSM_Data_subLB2, maxmin_scalar_LB_complete))

scaling_maxmin_LB_complete$School_ID <- rownames(CASchools_PSM_Data_subLB2)  

scaling_maxmin_LB_complete$Percent_Forest[scaling_maxmin_LB_complete$Percent_Forest] <- 0

scaling_maxmin_LB_complete$Percent_Forest[which(scaling_maxmin_LB_complete$Percent_Forest == "NaN")] = 0.0000000
```

```{r EE Retrofit = 7. Lighting + Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_LP_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_LP_complete <- as.data.frame(lapply(CASchools_PSM_Data_subLP2, maxmin_scalar_LP_complete))
scaling_maxmin_LP_complete$School_ID <- rownames(CASchools_PSM_Data_subLP2)  
```

```{r  EE Retrofit = 8. HVAC + Building Envelope}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_HB_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_HB_complete <- as.data.frame(lapply(CASchools_PSM_Data_subHB2, maxmin_scalar_HB_complete))

scaling_maxmin_HB_complete$School_ID <- rownames(CASchools_PSM_Data_subHB2)  

scaling_maxmin_HB_complete$Percent_Forest[scaling_maxmin_HB_complete$Percent_Forest] <- 0

scaling_maxmin_HB_complete$Percent_Forest[which(scaling_maxmin_HB_complete$Percent_Forest == "NaN")] = 0.0000000
```

```{r EE Retrofit = 9. HVAC + Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_HP_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_HP_complete <- as.data.frame(lapply(CASchools_PSM_Data_subHP2, maxmin_scalar_HP_complete))
scaling_maxmin_HP_complete$School_ID <- rownames(CASchools_PSM_Data_subHP2)  
```


```{r EE Retrofit = 10. Building Envelope + Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_BP_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_BP_complete <- as.data.frame(lapply(CASchools_PSM_Data_subBP2, maxmin_scalar_BP_complete))
scaling_maxmin_BP_complete$School_ID <- rownames(CASchools_PSM_Data_subBP2)  
```


```{r  EE Retrofit = 11. Lighting +  HVAC + Building Envelope}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_LHB_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_LHB_complete <- as.data.frame(lapply(CASchools_PSM_Data_subLHB2, maxmin_scalar_LHB_complete))

scaling_maxmin_LHB_complete$School_ID <- rownames(CASchools_PSM_Data_subLHB2)  

scaling_maxmin_LHB_complete$Percent_Forest[scaling_maxmin_LHB_complete$Percent_Forest] <- 0

scaling_maxmin_LHB_complete$Percent_Forest[which(scaling_maxmin_LHB_complete$Percent_Forest == "NaN")] = 0.0000000
```

```{r EE Retrofit = 12. Lighting + HVAC + Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_LHP_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_LHP_complete <- as.data.frame(lapply(CASchools_PSM_Data_subLHP2, maxmin_scalar_LHP_complete))
scaling_maxmin_LHP_complete$School_ID <- rownames(CASchools_PSM_Data_subLHP2)  
```


```{r EE Retrofit = 13. HVAC + Building Envelope + Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_HBP_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_HBP_complete <- as.data.frame(lapply(CASchools_PSM_Data_subHBP2, maxmin_scalar_HBP_complete))
scaling_maxmin_HBP_complete$School_ID <- rownames(CASchools_PSM_Data_subHBP2)  
```


```{r EE Retrofit = 14. Building Envelope + Lighting +  Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_BLP_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_BLP_complete <- as.data.frame(lapply(CASchools_PSM_Data_subBLP2, maxmin_scalar_BLP_complete))
scaling_maxmin_BLP_complete$School_ID <- rownames(CASchools_PSM_Data_subBLP2)  
```

# Pair-Matching Algorithm - 3 Scenarios

## Using non-imputed data

### Scenario 1 = Energy Efficiency (EE) Retrofits in K-12 Schools

```{r}
library(MatchIt)
#
#1:1 optimal PS matching with optimal matching on School covariates
m.out1 <- matchit(retrofit ~ 
                    NDVI_median +	
                    Percent_Water	+ Percent_Developed + Percent_Forest +	
                    Percent_Pasture + Land_Surface_Temp + Year_built +
                    Median_income_BG +	Percent_FRPM + Staff +
                    Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_dropna,
                  method = "optimal") 
summary(m.out1)


### Scenario 1: Energy Efficiency Retrofits in K-12 Schools
m.out1
summary(m.out1, un = FALSE)

m_data <- match.data(m.out1)
mm <- na.omit(m.out1$match.matrix)
m_data <- m_data[rownames(m_data) %in% rownames(mm) |
                   rownames(m_data) %in% mm,]
#print(m_data)
```



### Scenario 2 = Nature Exposure in K-12 Schools
```{r}
m.out2 <- matchit(ndvi_median_binary ~ 
                    retrofit +	
                    Percent_Water	+ Percent_Developed + Percent_Forest +	
                    Percent_Pasture + Land_Surface_Temp + Year_built +
                    Median_income_BG +	Percent_FRPM + Staff +	
                    Asthma_Rates + COVID_infections +	Pollution_Burden,
                   data = scaling_maxmin_dropna,
                   method = "optimal")
summary(m.out2)

### Scenario 2: Nature Exposure in K-12 Schools
m.out2
summary(m.out2, un = FALSE)
m_data2 <- match.data(m.out2)
mm2 <- na.omit(m.out2$match.matrix)
m_data2 <- m_data2[rownames(m_data2) %in% rownames(mm2) |
                   rownames(m_data2) %in% mm2,]
```



### Scenario 3 = Energy Efficiency Retrofits and Nature Exposure in K-12 Schools 
```{r}
m.out3 <- matchit(retrofit_and_ndvi ~ 
                    Percent_Water	+ Percent_Developed + Percent_Forest +	
                    Percent_Pasture + Land_Surface_Temp	+ Year_built +
                    Median_income_BG +	Percent_FRPM + Staff +
                    Asthma_Rates + COVID_infections +	Pollution_Burden,
                   data = scaling_maxmin_dropna,
                   method = "optimal")
summary(m.out3)

### Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools 
m.out3
summary(m.out3, un = FALSE)
m_data3 <- match.data(m.out3)
mm3 <- na.omit(m.out3$match.matrix)
m_data3 <- m_data3[rownames(m_data3) %in% rownames(mm3) |
                   rownames(m_data3) %in% mm3,]
```


## Using Imputed Data

### Scenario 1 = Energy Efficiency Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_complete,
                  method = "optimal") 
summary(m.out1_complete)
 
m.out1_complete
summary(m.out1_complete, un = FALSE)
m_data_complete <- match.data(m.out1_complete)
```

##Single EE Retrofit
#### Scenario 1L = Lighting Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1L_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_L_complete,
                  method = "optimal") 
summary(m.out1L_complete)
 
m.out1L_complete
summary(m.out1L_complete, un = FALSE)
m_data_L_complete <- match.data(m.out1L_complete)
```


#### Scenario 1H = HVAC Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1H_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_H_complete,
                  method = "optimal") 
summary(m.out1H_complete)
 
m.out1H_complete
summary(m.out1H_complete, un = FALSE)
m_data_H_complete <- match.data(m.out1H_complete)

```


#### Scenario 1B = Building Envelope Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1B_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_B_complete,
                  method = "optimal") 
summary(m.out1B_complete)
 
m.out1B_complete
summary(m.out1B_complete, un = FALSE)
m_data_B_complete <- match.data(m.out1B_complete)

```


#### Scenario 1P = Pumps, Motors, & Drives Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1P_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_P_complete,
                  method = "optimal") 
summary(m.out1P_complete)
 
m.out1P_complete
summary(m.out1P_complete, un = FALSE)
m_data_P_complete <- match.data(m.out1P_complete)

```




##Dual EE Retrofit

#### Scenario 1LH = Lighting + HVAC in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1LH_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LH_complete,
                  method = "optimal") 
summary(m.out1LH_complete)
 
m.out1LH_complete
summary(m.out1LH_complete, un = FALSE)
m_data_LH_complete <- match.data(m.out1LH_complete)
```


#### Scenario 1LB = Lighting + Builing Envelope in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1LB_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LB_complete,
                  method = "optimal") 
summary(m.out1LB_complete)
 
m.out1LB_complete
summary(m.out1LB_complete, un = FALSE)
m_data_LB_complete <- match.data(m.out1LB_complete)

```


#### Scenario 1LP = Lighting + Pumps, Motors, & Drives in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1LP_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LP_complete,
                  method = "optimal") 
summary(m.out1LP_complete)
 
m.out1LP_complete
summary(m.out1LP_complete, un = FALSE)
m_data_LP_complete <- match.data(m.out1LP_complete)

```


#### Scenario 1HB = HVAC + Builing Envelope in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1HB_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_HB_complete,
                  method = "optimal") 
summary(m.out1HB_complete)
 
m.out1HB_complete
summary(m.out1HB_complete, un = FALSE)
m_data_HB_complete <- match.data(m.out1HB_complete)

```

#### Scenario 1HP = HVAC + Pumps, Motors, & Drives in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1HP_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_HP_complete,
                  method = "optimal") 
summary(m.out1HP_complete)
 
m.out1HP_complete
summary(m.out1HP_complete, un = FALSE)
m_data_HP_complete <- match.data(m.out1HP_complete)

```


#### Scenario 1BP = Building Envelope + Pumps, Motors, & Drives in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1BP_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_BP_complete,
                  method = "optimal") 
summary(m.out1BP_complete)
 
m.out1BP_complete
summary(m.out1BP_complete, un = FALSE)
m_data_BP_complete <- match.data(m.out1BP_complete)

```


##Triple EE Retrofit

#### Scenario 1LHB = Lighting + HVAC + Building Envelope in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1LHB_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LHB_complete,
                  method = "optimal") 
summary(m.out1LHB_complete)
 
m.out1LHB_complete
summary(m.out1LHB_complete, un = FALSE)
m_data_LHB_complete <- match.data(m.out1LHB_complete)
```


#### Scenario 1LHP = Lighting + HVAC + Pumps, Motors, & Drives in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1LHP_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LHP_complete,
                  method = "optimal") 
summary(m.out1LHP_complete)
 
m.out1LHP_complete
summary(m.out1LHP_complete, un = FALSE)
m_data_LHP_complete <- match.data(m.out1LHP_complete)

```


#### Scenario 1HBP = HVAC + Building Envelope + Pumps, Motors, & Drives in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1HBP_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_HBP_complete,
                  method = "optimal") 
summary(m.out1HBP_complete)
 
m.out1HBP_complete
summary(m.out1HBP_complete, un = FALSE)
m_data_HBP_complete <- match.data(m.out1HBP_complete)

```


#### Scenario 1BLP = Builing Envelope + Lighting + Pumps, Motors, & Drives in K-12 Schools in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1BLP_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_BLP_complete,
                  method = "optimal") 
summary(m.out1BLP_complete)
 
m.out1BLP_complete
summary(m.out1BLP_complete, un = FALSE)
m_data_BLP_complete <- match.data(m.out1BLP_complete)

```



### Scenario 2 = Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out2_complete <- matchit(ndvi_median_binary ~ retrofit +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +	
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                   data = scaling_maxmin_complete,
                   method = "optimal")
summary(m.out2_complete)
m.out2_complete
summary(m.out2_complete, un = FALSE)
m_data2_complete <- match.data(m.out2_complete)
```


### Scenario 3 = Energy Efficiency Retrofits + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_complete,
                  method = "optimal")
summary(m.out3_complete)

m.out3_complete
summary(m.out3_complete, un = FALSE)
m_data3_complete <- match.data(m.out3_complete)
```

##Single EE Retrofit

#### Scenario 3L = Lighting Retrofits + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_L <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_L_complete,
                  method = "optimal")
summary(m.out3_complete_L)

m.out3_complete_L
summary(m.out3_complete_L, un = FALSE)
m_data3_complete_L <- match.data(m.out3_complete_L)
```

#### Scenario 3H = HVAC Retrofits + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_H <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_H_complete,
                  method = "optimal")
summary(m.out3_complete_H)

m.out3_complete_H
summary(m.out3_complete_H, un = FALSE)
m_data3_complete_H <- match.data(m.out3_complete_H)
```

#### Scenario 3B = Building Envelope Retrofits + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_B <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_B_complete,
                  method = "optimal")
summary(m.out3_complete_B)

m.out3_complete_B
summary(m.out3_complete_B, un = FALSE)
m_data3_complete_B <- match.data(m.out3_complete_B)
```


#### Scenario 3P = Pumps, Motors, & Drives Retrofits + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_P <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_P_complete,
                  method = "optimal")
summary(m.out3_complete_P)

m.out3_complete
summary(m.out3_complete_P, un = FALSE)
m_data3_complete_P <- match.data(m.out3_complete_P)
```


##Dual EE Retrofit


#### Scenario 3LH = Lighting  + HVAC + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_LH <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LH_complete,
                  method = "optimal")
summary(m.out3_complete_LH)

m.out3_complete_LH
summary(m.out3_complete_LH, un = FALSE)
m_data3_complete_LH <- match.data(m.out3_complete_LH)
```

#### Scenario 3LB = Lighting + Builing Envelope + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_LB <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LB_complete,
                  method = "optimal")
summary(m.out3_complete_LB)

m.out3_complete_LB
summary(m.out3_complete_LB, un = FALSE)
m_data3_complete_LB <- match.data(m.out3_complete_LB)
```

#### Scenario 3LP = Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_LP <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LP_complete,
                  method = "optimal")
summary(m.out3_complete_LP)

m.out3_complete_LP
summary(m.out3_complete_LP, un = FALSE)
m_data3_complete_LP <- match.data(m.out3_complete_LP)
```

#### Scenario 3HB = HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_HB <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_HB_complete,
                  method = "optimal")
summary(m.out3_complete_HB)

m.out3_complete
summary(m.out3_complete_HB, un = FALSE)
m_data3_complete_HB <- match.data(m.out3_complete_HB)
```


#### Scenario 3HP =  HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_HP <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_HP_complete,
                  method = "optimal")
summary(m.out3_complete_HP)

m.out3_complete_HP
summary(m.out3_complete_HP, un = FALSE)
m_data3_complete_HP<- match.data(m.out3_complete_HP)
```

#### Scenario 3BP = Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_BP <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_BP_complete,
                  method = "optimal")
summary(m.out3_complete_BP)

m.out3_complete_BP
summary(m.out3_complete_BP, un = FALSE)
m_data3_complete_BP <- match.data(m.out3_complete_BP)
```

##Triple EE Retrofit

#### Scenario 3LHB = Lighting + HVAC + Builing Envelope + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_LHB <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LHB_complete,
                  method = "optimal")
summary(m.out3_complete_LHB)

m.out3_complete_LHB
summary(m.out3_complete_LHB, un = FALSE)
m_data3_complete_LHB <- match.data(m.out3_complete_LHB)
```

#### Scenario 3LHP = Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_LHP <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_LHP_complete,
                  method = "optimal")
summary(m.out3_complete_LHP)

m.out3_complete_LHP
summary(m.out3_complete_LHP, un = FALSE)
m_data3_complete_LHP <- match.data(m.out3_complete_LHP)
```

#### Scenario 3HBP = HVAC + Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_HBP <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_HBP_complete,
                  method = "optimal")
summary(m.out3_complete_HBP)

m.out3_complete
summary(m.out3_complete_HBP, un = FALSE)
m_data3_complete_HBP <- match.data(m.out3_complete_HBP)
```


#### Scenario 3BLP = Building Envelope + Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_BLP <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Asthma_Rates + COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_BLP_complete,
                  method = "optimal")
summary(m.out3_complete_BLP)

m.out3_complete_BLP
summary(m.out3_complete_BLP, un = FALSE)
m_data3_complete_BLP <- match.data(m.out3_complete_BLP)
```





## Control and Treatment subsets

### Raw Data
```{r Scenario 1}
### Scenario 1: Energy Efficiency Retrofits in K-12 Schools

#Control Group 
m_data_c <- m_data %>%
  dplyr::filter(retrofit == 0 )

#Treatment Group
m_data_t <- m_data %>%
  dplyr::filter(retrofit == 1)


## left join raw outcome data
raw <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data_c_withRaw <- m_data_c %>%
  left_join(., raw, by = 'School_ID')


m_data_t_withRaw <- m_data_t %>%
  left_join(., raw, by = 'School_ID')

m_data_wide <- merge(
  x = m_data_c, 
  y = m_data_t,
  by = 'subclass'
)

m_data_wide_2 <- merge(
  x = m_data_c_withRaw, 
  y = m_data_t_withRaw,
  by = 'subclass'
)
```




```{r Scenario 2}
## Scenario 2: Nature Exposure in K-12 Schools

#Control Group 
m_data2_c <- m_data2 %>%
  dplyr::filter(ndvi_median_binary == 0 )

#Treatment Group
m_data2_t <- m_data2 %>%
  dplyr::filter(ndvi_median_binary == 1)


## left join raw outcome data
raw_2 <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data2_c_withRaw <- m_data2_c %>%
  left_join(., raw_2, by = 'School_ID')


m_data2_t_withRaw <- m_data2_t %>%
  left_join(., raw_2, by = 'School_ID')

m_data_wide_3 <- merge(
  x = m_data2_c, 
  y = m_data2_t,
  by = 'subclass'
)

m_data_wide_4 <- merge(
  x = m_data2_c_withRaw, 
  y = m_data2_t_withRaw,
  by = 'subclass'
)
```



```{r Scenario 3}
## Scenario 3: Energy Efficiency and Nature Exposure in K-12 Schools

#Control Group 
m_data3_c <- m_data3 %>%
  dplyr::filter(retrofit_and_ndvi == 0 )

#Treatment Group
m_data3_t <- m_data3 %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3 <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw <- m_data3_c %>%
  left_join(., raw_3, by = 'School_ID')


m_data3_t_withRaw <- m_data3_t %>%
  left_join(., raw_3, by = 'School_ID')

m_data_wide_5 <- merge(
  x = m_data3_c, 
  y = m_data3_t,
  by = 'subclass'
)

m_data_wide_6 <- merge(
  x = m_data3_c_withRaw, 
  y = m_data3_t_withRaw,
  by = 'subclass'
)
```

### Imputed Data Scenario 1

```{r Scenario 1}
### Scenario 1: Energy Efficiency Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete <- m_data_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete <- m_data_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete <- m_data_c_complete %>%
  left_join(., raw_complete, by = 'School_ID')

m_data_t_withRaw_complete <- m_data_t_complete %>%
  left_join(., raw_complete, by = 'School_ID')

m_data_wide_complete <- merge(
  x = m_data_c_complete, 
  y = m_data_t_complete,
  by = 'subclass'
)

m_data_wide_2_complete <- merge(
  x = m_data_c_withRaw_complete, 
  y = m_data_t_withRaw_complete,
  by = 'subclass'
)
```


# Single EE Retrofit
#### Imputed Data 1L

```{r Scenario 1L}
### Scenario 1 = Lighting Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_L <- m_data_L_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_L <- m_data_L_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_L <- CASchools_PSM_Data_subL2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_L <- m_data_c_complete_L %>%
  left_join(., raw_complete_L, by = 'School_ID')

m_data_t_withRaw_complete_L <- m_data_t_complete_L %>%
  left_join(., raw_complete_L, by = 'School_ID')

m_data_wide_complete_L <- merge(
  x = m_data_c_complete_L, 
  y = m_data_t_complete_L,
  by = 'subclass'
)

m_data_wide_2_complete_L <- merge(
  x = m_data_c_withRaw_complete_L, 
  y = m_data_t_withRaw_complete_L,
  by = 'subclass'
)
```



#### Imputed Data 1H

```{r Scenario 1H}
### Scenario 1 = HVAC Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_H <- m_data_H_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_H <- m_data_H_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_H <- CASchools_PSM_Data_subH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_H <- m_data_c_complete_H %>%
  left_join(., raw_complete_H, by = 'School_ID')

m_data_t_withRaw_complete_H <- m_data_t_complete_H %>%
  left_join(., raw_complete_H, by = 'School_ID')

m_data_wide_complete_H <- merge(
  x = m_data_c_complete_H, 
  y = m_data_t_complete_H,
  by = 'subclass'
)

m_data_wide_2_complete_H <- merge(
  x = m_data_c_withRaw_complete_H, 
  y = m_data_t_withRaw_complete_H,
  by = 'subclass'
)
```

#### Imputed Data 1B

```{r Scenario 1B}
### Scenario 1B = Building Envelope Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_B <- m_data_B_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_B <- m_data_B_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_B <- CASchools_PSM_Data_subB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_B <- m_data_c_complete_B %>%
  left_join(., raw_complete_B, by = 'School_ID')

m_data_t_withRaw_complete_B <- m_data_t_complete_B %>%
  left_join(., raw_complete_B, by = 'School_ID')

m_data_wide_complete_B <- merge(
  x = m_data_c_complete_B, 
  y = m_data_t_complete_B,
  by = 'subclass'
)

m_data_wide_2_complete_B <- merge(
  x = m_data_c_withRaw_complete_B, 
  y = m_data_t_withRaw_complete_B,
  by = 'subclass'
)
```

#### Imputed Data 1P

```{r Scenario 1P}
### Scenario 1P = Pumps, Motors, & Drives Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_P <- m_data_P_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_P <- m_data_P_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_P <- CASchools_PSM_Data_subP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_P <- m_data_c_complete_P %>%
  left_join(., raw_complete_P, by = 'School_ID')

m_data_t_withRaw_complete_P <- m_data_t_complete_P %>%
  left_join(., raw_complete_P, by = 'School_ID')

m_data_wide_complete_P <- merge(
  x = m_data_c_complete_P, 
  y = m_data_t_complete_P,
  by = 'subclass'
)

m_data_wide_2_complete_P <- merge(
  x = m_data_c_withRaw_complete_P, 
  y = m_data_t_withRaw_complete_P,
  by = 'subclass'
)
```

#Dual EE Retrofit
#### Imputed Data 1LH

```{r Scenario 1LH}
### Scenario 1 = Lighting + HVAC in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LH <- m_data_LH_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LH <- m_data_LH_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LH <- CASchools_PSM_Data_subLH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LH <- m_data_c_complete_LH %>%
  left_join(., raw_complete_LH, by = 'School_ID')

m_data_t_withRaw_complete_LH <- m_data_t_complete_LH %>%
  left_join(., raw_complete_LH, by = 'School_ID')

m_data_wide_complete_LH <- merge(
  x = m_data_c_complete_LH, 
  y = m_data_t_complete_LH,
  by = 'subclass'
)

m_data_wide_2_complete_LH <- merge(
  x = m_data_c_withRaw_complete_LH, 
  y = m_data_t_withRaw_complete_LH,
  by = 'subclass'
)
```


#### Imputed Data 1LB

```{r Scenario 1LB}
### Scenario 1LB = Lighting + Building Envelope in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LB <- m_data_LB_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LB <- m_data_LB_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LB <- CASchools_PSM_Data_subLB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LB <- m_data_c_complete_LB %>%
  left_join(., raw_complete_LB, by = 'School_ID')

m_data_t_withRaw_complete_LB <- m_data_t_complete_LB %>%
  left_join(., raw_complete_LB, by = 'School_ID')

m_data_wide_complete_LB <- merge(
  x = m_data_c_complete_LB, 
  y = m_data_t_complete_LB,
  by = 'subclass'
)

m_data_wide_2_complete_LB <- merge(
  x = m_data_c_withRaw_complete_LB, 
  y = m_data_t_withRaw_complete_LB,
  by = 'subclass'
)
```

#### Imputed Data 1LP

```{r Scenario 1LP}
### Scenario 1LP = Lighting + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LP <- m_data_LP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LP <- m_data_LP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LP <- CASchools_PSM_Data_subLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LP <- m_data_c_complete_LP %>%
  left_join(., raw_complete_LP, by = 'School_ID')

m_data_t_withRaw_complete_LP <- m_data_t_complete_LP %>%
  left_join(., raw_complete_LP, by = 'School_ID')

m_data_wide_complete_LP <- merge(
  x = m_data_c_complete_LP, 
  y = m_data_t_complete_LP,
  by = 'subclass'
)

m_data_wide_2_complete_LP <- merge(
  x = m_data_c_withRaw_complete_LP, 
  y = m_data_t_withRaw_complete_LP,
  by = 'subclass'
)
```

#### Imputed Data 1HB

```{r Scenario 1HB}
### Scenario 1HB = HVAC + Building Envelope in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_HB <- m_data_HB_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_HB <- m_data_HB_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_HB <- CASchools_PSM_Data_subHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_HB <- m_data_c_complete_HB %>%
  left_join(., raw_complete_HB, by = 'School_ID')

m_data_t_withRaw_complete_HB <- m_data_t_complete_HB %>%
  left_join(., raw_complete_HB, by = 'School_ID')

m_data_wide_complete_HB <- merge(
  x = m_data_c_complete_HB, 
  y = m_data_t_complete_HB,
  by = 'subclass'
)

m_data_wide_2_complete_HB <- merge(
  x = m_data_c_withRaw_complete_HB, 
  y = m_data_t_withRaw_complete_HB,
  by = 'subclass'
)
```



#### Imputed Data 1HP

```{r Scenario 1HP}
### Scenario 1P = HVAC + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_HP <- m_data_HP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_HP <- m_data_HP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_HP <- CASchools_PSM_Data_subHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_HP <- m_data_c_complete_HP %>%
  left_join(., raw_complete_HP, by = 'School_ID')

m_data_t_withRaw_complete_HP <- m_data_t_complete_HP %>%
  left_join(., raw_complete_HP, by = 'School_ID')

m_data_wide_complete_HP <- merge(
  x = m_data_c_complete_HP, 
  y = m_data_t_complete_HP,
  by = 'subclass'
)

m_data_wide_2_complete_HP <- merge(
  x = m_data_c_withRaw_complete_HP, 
  y = m_data_t_withRaw_complete_HP,
  by = 'subclass'
)
```

#### Imputed Data 1BP

```{r Scenario 1BP}
### Scenario 1BP = Building Envelope + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_BP <- m_data_BP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_BP <- m_data_BP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_BP <- CASchools_PSM_Data_subBP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_BP <- m_data_c_complete_BP %>%
  left_join(., raw_complete_BP, by = 'School_ID')

m_data_t_withRaw_complete_BP <- m_data_t_complete_BP %>%
  left_join(., raw_complete_BP, by = 'School_ID')

m_data_wide_complete_BP <- merge(
  x = m_data_c_complete_BP, 
  y = m_data_t_complete_BP,
  by = 'subclass'
)

m_data_wide_2_complete_BP <- merge(
  x = m_data_c_withRaw_complete_BP, 
  y = m_data_t_withRaw_complete_BP,
  by = 'subclass'
)
```



#Triple EE Retrofit

#### Imputed Data 1LHB

```{r Scenario 1LHB}
### Scenario 1LHB = Lighting + HVAC + Building Envelope in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LHB <- m_data_LHB_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LHB <- m_data_LHB_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LHB <- CASchools_PSM_Data_subLHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LHB <- m_data_c_complete_LHB %>%
  left_join(., raw_complete_LHB, by = 'School_ID')

m_data_t_withRaw_complete_LHB <- m_data_t_complete_LHB %>%
  left_join(., raw_complete_LHB, by = 'School_ID')

m_data_wide_complete_LHB <- merge(
  x = m_data_c_complete_LHB, 
  y = m_data_t_complete_LHB,
  by = 'subclass'
)

m_data_wide_2_complete_LHB <- merge(
  x = m_data_c_withRaw_complete_LHB, 
  y = m_data_t_withRaw_complete_LHB,
  by = 'subclass'
)
```



#### Imputed Data 1LHP

```{r Scenario 1LHP}
### Scenario 1LHP = Lighting + HVAC + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LHP <- m_data_LHP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LHP <- m_data_LHP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LHP <- CASchools_PSM_Data_subLHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LHP <- m_data_c_complete_LHP %>%
  left_join(., raw_complete_LHP, by = 'School_ID')

m_data_t_withRaw_complete_LHP <- m_data_t_complete_LHP %>%
  left_join(., raw_complete_LHP, by = 'School_ID')

m_data_wide_complete_LHP <- merge(
  x = m_data_c_complete_LHP, 
  y = m_data_t_complete_LHP,
  by = 'subclass'
)

m_data_wide_2_complete_LHP <- merge(
  x = m_data_c_withRaw_complete_LHP, 
  y = m_data_t_withRaw_complete_LHP,
  by = 'subclass'
)
```

#### Imputed Data 1HBP

```{r Scenario 1HBP}
### Scenario 1HBP = HVAC + Building Envelope + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_HBP <- m_data_HBP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_HBP <- m_data_HBP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_HBP <- CASchools_PSM_Data_subBLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_HBP <- m_data_c_complete_HBP %>%
  left_join(., raw_complete_HBP, by = 'School_ID')

m_data_t_withRaw_complete_HBP <- m_data_t_complete_HBP %>%
  left_join(., raw_complete_HBP, by = 'School_ID')

m_data_wide_complete_HBP <- merge(
  x = m_data_c_complete_HBP, 
  y = m_data_t_complete_HBP,
  by = 'subclass'
)

m_data_wide_2_complete_HBP <- merge(
  x = m_data_c_withRaw_complete_HBP, 
  y = m_data_t_withRaw_complete_HBP,
  by = 'subclass'
)
```



#### Imputed Data 1BLP

```{r Scenario 1BLP}
### Scenario 1BLP = Building Envelope + Lighting + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_BLP <- m_data_BLP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_BLP <- m_data_BLP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_BLP <- CASchools_PSM_Data_subBLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_BLP <- m_data_c_complete_BLP %>%
  left_join(., raw_complete_BLP, by = 'School_ID')

m_data_t_withRaw_complete_BLP <- m_data_t_complete_BLP %>%
  left_join(., raw_complete_BLP, by = 'School_ID')

m_data_wide_complete_BLP <- merge(
  x = m_data_c_complete_BLP, 
  y = m_data_t_complete_BLP,
  by = 'subclass'
)

m_data_wide_2_complete_BLP <- merge(
  x = m_data_c_withRaw_complete_BLP, 
  y = m_data_t_withRaw_complete_BLP,
  by = 'subclass'
)
```



### Scenario 2

```{r Scenario 2}
### Scenario 2 = Nature Exposure in K-12 Schools with Imputed Data

#Control Group 
m_data2_c_complete <- m_data2_complete %>%
  dplyr::filter(ndvi_median_binary == 0 )

#Treatment Group
m_data2_t_complete <- m_data2_complete %>%
  dplyr::filter(ndvi_median_binary == 1)

## left join raw outcome data
raw_2_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data2_c_withRaw_complete <- m_data2_c_complete %>%
  left_join(., raw_2_complete, by = 'School_ID')

m_data2_t_withRaw_complete <- m_data2_t_complete %>%
  left_join(., raw_2_complete, by = 'School_ID')

m_data_wide_3_complete <- merge(
  x = m_data2_c_complete, 
  y = m_data2_t_complete,
  by = 'subclass'
)

m_data_wide_4_complete <- merge(
  x = m_data2_c_withRaw_complete, 
  y = m_data2_t_withRaw_complete,
  by = 'subclass'
)
```


### Scenario 3

```{r Scenario 3}
### Scenario 3 = Energy Efficiency + Nature Exposure in K-12 Schools with Imputed Data

#Control Group 
m_data3_c_complete <- m_data3_complete %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete <- m_data3_complete %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete <- m_data3_c_complete %>%
  left_join(., raw_3_complete, by = 'School_ID')


m_data3_t_withRaw_complete <- m_data3_t_complete %>%
  left_join(., raw_3_complete, by = 'School_ID')

m_data_wide_5_complete <- merge(
  x = m_data3_c_complete, 
  y = m_data3_t_complete,
  by = 'subclass'
)

m_data_wide_6_complete <- merge(
  x = m_data3_c_withRaw_complete, 
  y = m_data3_t_withRaw_complete,
  by = 'subclass'
)
```


# Single EE Retrofit
#### Imputed Data 3L

```{r Scenario 3L}
### Scenario 3L = Lighting + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_L <- m_data3_complete_L %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_L <- m_data3_complete_L %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_L <- CASchools_PSM_Data_subL2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_L <- m_data3_c_complete_L %>%
  left_join(., raw_3_complete_L, by = 'School_ID')


m_data3_t_withRaw_complete_L <- m_data3_t_complete_L %>%
  left_join(., raw_3_complete_L, by = 'School_ID')

m_data_wide_5_complete_L <- merge(
  x = m_data3_c_complete_L, 
  y = m_data3_t_complete_L,
  by = 'subclass'
)

m_data_wide_6_complete_L <- merge(
  x = m_data3_c_withRaw_complete_L, 
  y = m_data3_t_withRaw_complete_L,
  by = 'subclass'
)
```



#### Imputed Data 3H

```{r Scenario 3H}
### Scenario 3H = HVAC + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_H <- m_data3_complete_H %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_H <- m_data3_complete_H %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_H <- CASchools_PSM_Data_subH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_H <- m_data3_c_complete_H %>%
  left_join(., raw_3_complete_H, by = 'School_ID')


m_data3_t_withRaw_complete_H <- m_data3_t_complete_H %>%
  left_join(., raw_3_complete_H, by = 'School_ID')

m_data_wide_5_complete_H <- merge(
  x = m_data3_c_complete_H, 
  y = m_data3_t_complete_H,
  by = 'subclass'
)

m_data_wide_6_complete_H <- merge(
  x = m_data3_c_withRaw_complete_H, 
  y = m_data3_t_withRaw_complete_H,
  by = 'subclass'
)
```

#### Imputed Data 3B

```{r Scenario 3B}
### Scenario 3B = Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_B <- m_data3_complete_B %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_B <- m_data3_complete_B %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_B <- CASchools_PSM_Data_subB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_B <- m_data3_c_complete_B %>%
  left_join(., raw_3_complete_B, by = 'School_ID')


m_data3_t_withRaw_complete_B <- m_data3_t_complete_B %>%
  left_join(., raw_3_complete_B, by = 'School_ID')

m_data_wide_5_complete_B <- merge(
  x = m_data3_c_complete_B, 
  y = m_data3_t_complete_B,
  by = 'subclass'
)

m_data_wide_6_complete_B <- merge(
  x = m_data3_c_withRaw_complete_B, 
  y = m_data3_t_withRaw_complete_B,
  by = 'subclass'
)
```

#### Imputed Data 3P

```{r Scenario 3P}
### Scenario 3P = Pumps, Motors, & Drives Retrofits + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_P <- m_data3_complete_P %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_P <- m_data3_complete_P %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_P <- CASchools_PSM_Data_subP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_P <- m_data3_c_complete_P %>%
  left_join(., raw_3_complete_P, by = 'School_ID')


m_data3_t_withRaw_complete_P <- m_data3_t_complete_P %>%
  left_join(., raw_3_complete_P, by = 'School_ID')

m_data_wide_5_complete_P <- merge(
  x = m_data3_c_complete_P, 
  y = m_data3_t_complete_P,
  by = 'subclass'
)

m_data_wide_6_complete_P <- merge(
  x = m_data3_c_withRaw_complete_P, 
  y = m_data3_t_withRaw_complete_P,
  by = 'subclass'
)
```


#Dual EE Retrofit
#### Imputed Data 3LH

```{r Scenario 3LH}
### Scenario 3LH = Lighting + HVAC + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LH <- m_data3_complete_LH %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LH <- m_data3_complete_LH %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LH <- CASchools_PSM_Data_subLH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LH <- m_data3_c_complete_LH %>%
  left_join(., raw_3_complete_LH, by = 'School_ID')


m_data3_t_withRaw_complete_LH <- m_data3_t_complete_LH %>%
  left_join(., raw_3_complete_LH, by = 'School_ID')

m_data_wide_5_complete_LH <- merge(
  x = m_data3_c_complete_LH, 
  y = m_data3_t_complete_LH,
  by = 'subclass'
)

m_data_wide_6_complete_LH <- merge(
  x = m_data3_c_withRaw_complete_LH, 
  y = m_data3_t_withRaw_complete_LH,
  by = 'subclass'
)
```


#### Imputed Data 3LB

```{r Scenario 3LB}
### Scenario 3LB = Lighting + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LB <- m_data3_complete_LB %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LB <- m_data3_complete_LB %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LB <- CASchools_PSM_Data_subLB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LB <- m_data3_c_complete_LB %>%
  left_join(., raw_3_complete_LB, by = 'School_ID')


m_data3_t_withRaw_complete_LB <- m_data3_t_complete_LB %>%
  left_join(., raw_3_complete_LB, by  = 'School_ID')

m_data_wide_5_complete_LB <- merge(
  x = m_data3_c_complete_LB, 
  y = m_data3_t_complete_LB,
  by = 'subclass'
)

m_data_wide_6_complete_LB <- merge(
  x = m_data3_c_withRaw_complete_LB, 
  y = m_data3_t_withRaw_complete_LB,
  by = 'subclass'
)
```

#### Imputed Data 3LP

```{r Scenario 3LP}
### Scenario 3LP: Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LP <- m_data3_complete_LP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LP <- m_data3_complete_LP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LP <- CASchools_PSM_Data_subLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LP <- m_data3_c_complete_LP %>%
  left_join(., raw_3_complete_LP, by = 'School_ID')


m_data3_t_withRaw_complete_LP <- m_data3_t_complete_LP %>%
  left_join(., raw_3_complete_LP, by = 'School_ID')

m_data_wide_5_complete_LP <- merge(
  x = m_data3_c_complete_LP, 
  y = m_data3_t_complete_LP,
  by = 'subclass'
)

m_data_wide_6_complete_LP <- merge(
  x = m_data3_c_withRaw_complete_LP, 
  y = m_data3_t_withRaw_complete_LP,
  by = 'subclass'
)
```

#### Imputed Data 3HB

```{r Scenario 3HB}
### Scenario 3HB = HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_HB <- m_data3_complete_HB %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_HB <- m_data3_complete_HB %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_HB <- CASchools_PSM_Data_subHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_HB <- m_data3_c_complete_HB %>%
  left_join(., raw_3_complete_HB, by = 'School_ID')


m_data3_t_withRaw_complete_HB <- m_data3_t_complete_HB %>%
  left_join(., raw_3_complete_HB, by = 'School_ID')

m_data_wide_5_complete_HB <- merge(
  x = m_data3_c_complete_HB, 
  y = m_data3_t_complete_HB,
  by = 'subclass'
)

m_data_wide_6_complete_HB <- merge(
  x = m_data3_c_withRaw_complete_HB, 
  y = m_data3_t_withRaw_complete_HB,
  by = 'subclass'
)
```


#### Imputed Data 3HP

```{r Scenario 3HP}
### Scenario 3LP = HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_HP <- m_data3_complete_HP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_HP <- m_data3_complete_HP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_HP <- CASchools_PSM_Data_subHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_HP <- m_data3_c_complete_HP %>%
  left_join(., raw_3_complete_HP, by = 'School_ID')


m_data3_t_withRaw_complete_HP <- m_data3_t_complete_HP %>%
  left_join(., raw_3_complete_HP, by = 'School_ID')

m_data_wide_5_complete_HP <- merge(
  x = m_data3_c_complete_HP, 
  y = m_data3_t_complete_HP,
  by = 'subclass'
)

m_data_wide_6_complete_HP <- merge(
  x = m_data3_c_withRaw_complete_HP, 
  y = m_data3_t_withRaw_complete_HP,
  by = 'subclass'
)
```

#### Imputed Data 3BP

```{r Scenario 3BP}
### Scenario 3HB = Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_BP <- m_data3_complete_BP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_BP <- m_data3_complete_BP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_BP <- CASchools_PSM_Data_subBP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_BP <- m_data3_c_complete_BP %>%
  left_join(., raw_3_complete_BP, by = 'School_ID')


m_data3_t_withRaw_complete_BP <- m_data3_t_complete_BP %>%
  left_join(., raw_3_complete_BP, by = 'School_ID')

m_data_wide_5_complete_BP <- merge(
  x = m_data3_c_complete_BP, 
  y = m_data3_t_complete_BP,
  by = 'subclass'
)

m_data_wide_6_complete_BP <- merge(
  x = m_data3_c_withRaw_complete_BP, 
  y = m_data3_t_withRaw_complete_BP,
  by = 'subclass'
)
```

#Triple EE Retrofit
#### Imputed Data 3LHB

```{r Scenario 3LHB}
### Scenario 3LHB = Lighting + HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LHB <- m_data3_complete_LHB %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LHB <- m_data3_complete_LHB %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LHB <- CASchools_PSM_Data_subLHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LHB <- m_data3_c_complete_LHB %>%
  left_join(., raw_3_complete_LHB, by = 'School_ID')


m_data3_t_withRaw_complete_LHB <- m_data3_t_complete_LHB %>%
  left_join(., raw_3_complete_LHB, by  = 'School_ID')

m_data_wide_5_complete_LHB <- merge(
  x = m_data3_c_complete_LHB, 
  y = m_data3_t_complete_LHB,
  by = 'subclass'
)

m_data_wide_6_complete_LHB <- merge(
  x = m_data3_c_withRaw_complete_LHB, 
  y = m_data3_t_withRaw_complete_LHB,
  by = 'subclass'
)
```

#### Imputed Data 3LHP

```{r Scenario 3LHP}
### Scenario 3LP: Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LHP <- m_data3_complete_LHP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LHP <- m_data3_complete_LHP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LHP <- CASchools_PSM_Data_subLHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LHP <- m_data3_c_complete_LHP %>%
  left_join(., raw_3_complete_LHP, by = 'School_ID')


m_data3_t_withRaw_complete_LHP <- m_data3_t_complete_LHP %>%
  left_join(., raw_3_complete_LHP, by = 'School_ID')

m_data_wide_5_complete_LHP <- merge(
  x = m_data3_c_complete_LHP, 
  y = m_data3_t_complete_LHP,
  by = 'subclass'
)

m_data_wide_6_complete_LHP <- merge(
  x = m_data3_c_withRaw_complete_LHP, 
  y = m_data3_t_withRaw_complete_LHP,
  by = 'subclass'
)
```

#### Imputed Data 3HBP

```{r Scenario 3HBP}
### Scenario 3HBP = HVAC + Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_HBP <- m_data3_complete_HBP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_HBP <- m_data3_complete_HBP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_HBP <- CASchools_PSM_Data_subHBP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_HBP <- m_data3_c_complete_HBP %>%
  left_join(., raw_3_complete_HBP, by = 'School_ID')


m_data3_t_withRaw_complete_HBP <- m_data3_t_complete_HBP %>%
  left_join(., raw_3_complete_HBP, by = 'School_ID')

m_data_wide_5_complete_HBP <- merge(
  x = m_data3_c_complete_HBP, 
  y = m_data3_t_complete_HBP,
  by = 'subclass'
)

m_data_wide_6_complete_HBP <- merge(
  x = m_data3_c_withRaw_complete_HBP, 
  y = m_data3_t_withRaw_complete_HBP,
  by = 'subclass'
)
```


#### Imputed Data 3BLP

```{r Scenario 3BLP}
### Scenario 3BLP = Building Envelope + Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_BLP <- m_data3_complete_BLP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_BLP <- m_data3_complete_BLP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_BLP <- CASchools_PSM_Data_subBLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_BLP <- m_data3_c_complete_BLP %>%
  left_join(., raw_3_complete_BLP, by = 'School_ID')


m_data3_t_withRaw_complete_BLP <- m_data3_t_complete_BLP %>%
  left_join(., raw_3_complete_BLP, by = 'School_ID')

m_data_wide_5_complete_BLP<- merge(
  x = m_data3_c_complete_BLP, 
  y = m_data3_t_complete_BLP,
  by = 'subclass'
)

m_data_wide_6_complete_BLP <- merge(
  x = m_data3_c_withRaw_complete_BLP, 
  y = m_data3_t_withRaw_complete_BLP,
  by = 'subclass'
)
```

## Control and Treatment subsets

### Raw Data
```{r Scenario 1}
### Scenario 1: Energy Efficiency Retrofits in K-12 Schools

#Control Group 
m_data_c <- m_data %>%
  dplyr::filter(retrofit == 0 )

#Treatment Group
m_data_t <- m_data %>%
  dplyr::filter(retrofit == 1)


## left join raw outcome data
raw <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data_c_withRaw <- m_data_c %>%
  left_join(., raw, by = 'School_ID')


m_data_t_withRaw <- m_data_t %>%
  left_join(., raw, by = 'School_ID')

m_data_wide <- merge(
  x = m_data_c, 
  y = m_data_t,
  by = 'subclass'
)

m_data_wide_2 <- merge(
  x = m_data_c_withRaw, 
  y = m_data_t_withRaw,
  by = 'subclass'
)
```




```{r Scenario 2}
## Scenario 2: Nature Exposure in K-12 Schools

#Control Group 
m_data2_c <- m_data2 %>%
  dplyr::filter(ndvi_median_binary == 0 )

#Treatment Group
m_data2_t <- m_data2 %>%
  dplyr::filter(ndvi_median_binary == 1)


## left join raw outcome data
raw_2 <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data2_c_withRaw <- m_data2_c %>%
  left_join(., raw_2, by = 'School_ID')


m_data2_t_withRaw <- m_data2_t %>%
  left_join(., raw_2, by = 'School_ID')

m_data_wide_3 <- merge(
  x = m_data2_c, 
  y = m_data2_t,
  by = 'subclass'
)

m_data_wide_4 <- merge(
  x = m_data2_c_withRaw, 
  y = m_data2_t_withRaw,
  by = 'subclass'
)
```



```{r Scenario 3}
## Scenario 3: Energy Efficiency and Nature Exposure in K-12 Schools

#Control Group 
m_data3_c <- m_data3 %>%
  dplyr::filter(retrofit_and_ndvi == 0 )

#Treatment Group
m_data3_t <- m_data3 %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3 <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw <- m_data3_c %>%
  left_join(., raw_3, by = 'School_ID')


m_data3_t_withRaw <- m_data3_t %>%
  left_join(., raw_3, by = 'School_ID')

m_data_wide_5 <- merge(
  x = m_data3_c, 
  y = m_data3_t,
  by = 'subclass'
)

m_data_wide_6 <- merge(
  x = m_data3_c_withRaw, 
  y = m_data3_t_withRaw,
  by = 'subclass'
)
```

### Imputed Data Scenario 1

```{r Scenario 1}
### Scenario 1: Energy Efficiency Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete <- m_data_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete <- m_data_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete <- m_data_c_complete %>%
  left_join(., raw_complete, by = 'School_ID')

m_data_t_withRaw_complete <- m_data_t_complete %>%
  left_join(., raw_complete, by = 'School_ID')

m_data_wide_complete <- merge(
  x = m_data_c_complete, 
  y = m_data_t_complete,
  by = 'subclass'
)

m_data_wide_2_complete <- merge(
  x = m_data_c_withRaw_complete, 
  y = m_data_t_withRaw_complete,
  by = 'subclass'
)
```


# Single EE Retrofit
#### Imputed Data 1L

```{r Scenario 1L}
### Scenario 1 = Lighting Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_L <- m_data_L_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_L <- m_data_L_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_L <- CASchools_PSM_Data_subL2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_L <- m_data_c_complete_L %>%
  left_join(., raw_complete_L, by = 'School_ID')

m_data_t_withRaw_complete_L <- m_data_t_complete_L %>%
  left_join(., raw_complete_L, by = 'School_ID')

m_data_wide_complete_L <- merge(
  x = m_data_c_complete_L, 
  y = m_data_t_complete_L,
  by = 'subclass'
)

m_data_wide_2_complete_L <- merge(
  x = m_data_c_withRaw_complete_L, 
  y = m_data_t_withRaw_complete_L,
  by = 'subclass'
)
```



#### Imputed Data 1H

```{r Scenario 1H}
### Scenario 1 = HVAC Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_H <- m_data_H_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_H <- m_data_H_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_H <- CASchools_PSM_Data_subH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_H <- m_data_c_complete_H %>%
  left_join(., raw_complete_H, by = 'School_ID')

m_data_t_withRaw_complete_H <- m_data_t_complete_H %>%
  left_join(., raw_complete_H, by = 'School_ID')

m_data_wide_complete_H <- merge(
  x = m_data_c_complete_H, 
  y = m_data_t_complete_H,
  by = 'subclass'
)

m_data_wide_2_complete_H <- merge(
  x = m_data_c_withRaw_complete_H, 
  y = m_data_t_withRaw_complete_H,
  by = 'subclass'
)
```

#### Imputed Data 1B

```{r Scenario 1B}
### Scenario 1B = Building Envelope Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_B <- m_data_B_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_B <- m_data_B_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_B <- CASchools_PSM_Data_subB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_B <- m_data_c_complete_B %>%
  left_join(., raw_complete_B, by = 'School_ID')

m_data_t_withRaw_complete_B <- m_data_t_complete_B %>%
  left_join(., raw_complete_B, by = 'School_ID')

m_data_wide_complete_B <- merge(
  x = m_data_c_complete_B, 
  y = m_data_t_complete_B,
  by = 'subclass'
)

m_data_wide_2_complete_B <- merge(
  x = m_data_c_withRaw_complete_B, 
  y = m_data_t_withRaw_complete_B,
  by = 'subclass'
)
```

#### Imputed Data 1P

```{r Scenario 1P}
### Scenario 1P = Pumps, Motors, & Drives Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_P <- m_data_P_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_P <- m_data_P_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_P <- CASchools_PSM_Data_subP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_P <- m_data_c_complete_P %>%
  left_join(., raw_complete_P, by = 'School_ID')

m_data_t_withRaw_complete_P <- m_data_t_complete_P %>%
  left_join(., raw_complete_P, by = 'School_ID')

m_data_wide_complete_P <- merge(
  x = m_data_c_complete_P, 
  y = m_data_t_complete_P,
  by = 'subclass'
)

m_data_wide_2_complete_P <- merge(
  x = m_data_c_withRaw_complete_P, 
  y = m_data_t_withRaw_complete_P,
  by = 'subclass'
)
```

#Dual EE Retrofit
#### Imputed Data 1LH

```{r Scenario 1LH}
### Scenario 1 = Lighting + HVAC in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LH <- m_data_LH_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LH <- m_data_LH_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LH <- CASchools_PSM_Data_subLH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LH <- m_data_c_complete_LH %>%
  left_join(., raw_complete_LH, by = 'School_ID')

m_data_t_withRaw_complete_LH <- m_data_t_complete_LH %>%
  left_join(., raw_complete_LH, by = 'School_ID')

m_data_wide_complete_LH <- merge(
  x = m_data_c_complete_LH, 
  y = m_data_t_complete_LH,
  by = 'subclass'
)

m_data_wide_2_complete_LH <- merge(
  x = m_data_c_withRaw_complete_LH, 
  y = m_data_t_withRaw_complete_LH,
  by = 'subclass'
)
```


#### Imputed Data 1LB

```{r Scenario 1LB}
### Scenario 1LB = Lighting + Building Envelope in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LB <- m_data_LB_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LB <- m_data_LB_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LB <- CASchools_PSM_Data_subLB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LB <- m_data_c_complete_LB %>%
  left_join(., raw_complete_LB, by = 'School_ID')

m_data_t_withRaw_complete_LB <- m_data_t_complete_LB %>%
  left_join(., raw_complete_LB, by = 'School_ID')

m_data_wide_complete_LB <- merge(
  x = m_data_c_complete_LB, 
  y = m_data_t_complete_LB,
  by = 'subclass'
)

m_data_wide_2_complete_LB <- merge(
  x = m_data_c_withRaw_complete_LB, 
  y = m_data_t_withRaw_complete_LB,
  by = 'subclass'
)
```

#### Imputed Data 1LP

```{r Scenario 1LP}
### Scenario 1LP = Lighting + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LP <- m_data_LP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LP <- m_data_LP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LP <- CASchools_PSM_Data_subLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LP <- m_data_c_complete_LP %>%
  left_join(., raw_complete_LP, by = 'School_ID')

m_data_t_withRaw_complete_LP <- m_data_t_complete_LP %>%
  left_join(., raw_complete_LP, by = 'School_ID')

m_data_wide_complete_LP <- merge(
  x = m_data_c_complete_LP, 
  y = m_data_t_complete_LP,
  by = 'subclass'
)

m_data_wide_2_complete_LP <- merge(
  x = m_data_c_withRaw_complete_LP, 
  y = m_data_t_withRaw_complete_LP,
  by = 'subclass'
)
```

#### Imputed Data 1HB

```{r Scenario 1HB}
### Scenario 1HB = HVAC + Building Envelope in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_HB <- m_data_HB_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_HB <- m_data_HB_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_HB <- CASchools_PSM_Data_subHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_HB <- m_data_c_complete_HB %>%
  left_join(., raw_complete_HB, by = 'School_ID')

m_data_t_withRaw_complete_HB <- m_data_t_complete_HB %>%
  left_join(., raw_complete_HB, by = 'School_ID')

m_data_wide_complete_HB <- merge(
  x = m_data_c_complete_HB, 
  y = m_data_t_complete_HB,
  by = 'subclass'
)

m_data_wide_2_complete_HB <- merge(
  x = m_data_c_withRaw_complete_HB, 
  y = m_data_t_withRaw_complete_HB,
  by = 'subclass'
)
```



#### Imputed Data 1HP

```{r Scenario 1HP}
### Scenario 1P = HVAC + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_HP <- m_data_HP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_HP <- m_data_HP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_HP <- CASchools_PSM_Data_subHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_HP <- m_data_c_complete_HP %>%
  left_join(., raw_complete_HP, by = 'School_ID')

m_data_t_withRaw_complete_HP <- m_data_t_complete_HP %>%
  left_join(., raw_complete_HP, by = 'School_ID')

m_data_wide_complete_HP <- merge(
  x = m_data_c_complete_HP, 
  y = m_data_t_complete_HP,
  by = 'subclass'
)

m_data_wide_2_complete_HP <- merge(
  x = m_data_c_withRaw_complete_HP, 
  y = m_data_t_withRaw_complete_HP,
  by = 'subclass'
)
```

#### Imputed Data 1BP

```{r Scenario 1BP}
### Scenario 1BP = Building Envelope + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_BP <- m_data_BP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_BP <- m_data_BP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_BP <- CASchools_PSM_Data_subBP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_BP <- m_data_c_complete_BP %>%
  left_join(., raw_complete_BP, by = 'School_ID')

m_data_t_withRaw_complete_BP <- m_data_t_complete_BP %>%
  left_join(., raw_complete_BP, by = 'School_ID')

m_data_wide_complete_BP <- merge(
  x = m_data_c_complete_BP, 
  y = m_data_t_complete_BP,
  by = 'subclass'
)

m_data_wide_2_complete_BP <- merge(
  x = m_data_c_withRaw_complete_BP, 
  y = m_data_t_withRaw_complete_BP,
  by = 'subclass'
)
```



#Triple EE Retrofit

#### Imputed Data 1LHB

```{r Scenario 1LHB}
### Scenario 1LHB = Lighting + HVAC + Building Envelope in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LHB <- m_data_LHB_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LHB <- m_data_LHB_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LHB <- CASchools_PSM_Data_subLHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LHB <- m_data_c_complete_LHB %>%
  left_join(., raw_complete_LHB, by = 'School_ID')

m_data_t_withRaw_complete_LHB <- m_data_t_complete_LHB %>%
  left_join(., raw_complete_LHB, by = 'School_ID')

m_data_wide_complete_LHB <- merge(
  x = m_data_c_complete_LHB, 
  y = m_data_t_complete_LHB,
  by = 'subclass'
)

m_data_wide_2_complete_LHB <- merge(
  x = m_data_c_withRaw_complete_LHB, 
  y = m_data_t_withRaw_complete_LHB,
  by = 'subclass'
)
```



#### Imputed Data 1LHP

```{r Scenario 1LHP}
### Scenario 1LHP = Lighting + HVAC + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_LHP <- m_data_LHP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_LHP <- m_data_LHP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_LHP <- CASchools_PSM_Data_subLHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_LHP <- m_data_c_complete_LHP %>%
  left_join(., raw_complete_LHP, by = 'School_ID')

m_data_t_withRaw_complete_LHP <- m_data_t_complete_LHP %>%
  left_join(., raw_complete_LHP, by = 'School_ID')

m_data_wide_complete_LHP <- merge(
  x = m_data_c_complete_LHP, 
  y = m_data_t_complete_LHP,
  by = 'subclass'
)

m_data_wide_2_complete_LHP <- merge(
  x = m_data_c_withRaw_complete_LHP, 
  y = m_data_t_withRaw_complete_LHP,
  by = 'subclass'
)
```

#### Imputed Data 1HBP

```{r Scenario 1HBP}
### Scenario 1HBP = HVAC + Building Envelope + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_HBP <- m_data_HBP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_HBP <- m_data_HBP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_HBP <- CASchools_PSM_Data_subBLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_HBP <- m_data_c_complete_HBP %>%
  left_join(., raw_complete_HBP, by = 'School_ID')

m_data_t_withRaw_complete_HBP <- m_data_t_complete_HBP %>%
  left_join(., raw_complete_HBP, by = 'School_ID')

m_data_wide_complete_HBP <- merge(
  x = m_data_c_complete_HBP, 
  y = m_data_t_complete_HBP,
  by = 'subclass'
)

m_data_wide_2_complete_HBP <- merge(
  x = m_data_c_withRaw_complete_HBP, 
  y = m_data_t_withRaw_complete_HBP,
  by = 'subclass'
)
```



#### Imputed Data 1BLP

```{r Scenario 1BLP}
### Scenario 1BLP = Building Envelope + Lighting + Pumps, Motors, & Drives in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_BLP <- m_data_BLP_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_BLP <- m_data_BLP_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_BLP <- CASchools_PSM_Data_subBLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_BLP <- m_data_c_complete_BLP %>%
  left_join(., raw_complete_BLP, by = 'School_ID')

m_data_t_withRaw_complete_BLP <- m_data_t_complete_BLP %>%
  left_join(., raw_complete_BLP, by = 'School_ID')

m_data_wide_complete_BLP <- merge(
  x = m_data_c_complete_BLP, 
  y = m_data_t_complete_BLP,
  by = 'subclass'
)

m_data_wide_2_complete_BLP <- merge(
  x = m_data_c_withRaw_complete_BLP, 
  y = m_data_t_withRaw_complete_BLP,
  by = 'subclass'
)
```



### Scenario 2

```{r Scenario 2}
### Scenario 2 = Nature Exposure in K-12 Schools with Imputed Data

#Control Group 
m_data2_c_complete <- m_data2_complete %>%
  dplyr::filter(ndvi_median_binary == 0 )

#Treatment Group
m_data2_t_complete <- m_data2_complete %>%
  dplyr::filter(ndvi_median_binary == 1)

## left join raw outcome data
raw_2_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data2_c_withRaw_complete <- m_data2_c_complete %>%
  left_join(., raw_2_complete, by = 'School_ID')

m_data2_t_withRaw_complete <- m_data2_t_complete %>%
  left_join(., raw_2_complete, by = 'School_ID')

m_data_wide_3_complete <- merge(
  x = m_data2_c_complete, 
  y = m_data2_t_complete,
  by = 'subclass'
)

m_data_wide_4_complete <- merge(
  x = m_data2_c_withRaw_complete, 
  y = m_data2_t_withRaw_complete,
  by = 'subclass'
)
```


### Scenario 3

```{r Scenario 3}
### Scenario 3 = Energy Efficiency + Nature Exposure in K-12 Schools with Imputed Data

#Control Group 
m_data3_c_complete <- m_data3_complete %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete <- m_data3_complete %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete <- m_data3_c_complete %>%
  left_join(., raw_3_complete, by = 'School_ID')


m_data3_t_withRaw_complete <- m_data3_t_complete %>%
  left_join(., raw_3_complete, by = 'School_ID')

m_data_wide_5_complete <- merge(
  x = m_data3_c_complete, 
  y = m_data3_t_complete,
  by = 'subclass'
)

m_data_wide_6_complete <- merge(
  x = m_data3_c_withRaw_complete, 
  y = m_data3_t_withRaw_complete,
  by = 'subclass'
)
```


# Single EE Retrofit
#### Imputed Data 3L

```{r Scenario 3L}
### Scenario 3L = Lighting + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_L <- m_data3_complete_L %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_L <- m_data3_complete_L %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_L <- CASchools_PSM_Data_subL2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_L <- m_data3_c_complete_L %>%
  left_join(., raw_3_complete_L, by = 'School_ID')


m_data3_t_withRaw_complete_L <- m_data3_t_complete_L %>%
  left_join(., raw_3_complete_L, by = 'School_ID')

m_data_wide_5_complete_L <- merge(
  x = m_data3_c_complete_L, 
  y = m_data3_t_complete_L,
  by = 'subclass'
)

m_data_wide_6_complete_L <- merge(
  x = m_data3_c_withRaw_complete_L, 
  y = m_data3_t_withRaw_complete_L,
  by = 'subclass'
)
```



#### Imputed Data 3H

```{r Scenario 3H}
### Scenario 3H = HVAC + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_H <- m_data3_complete_H %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_H <- m_data3_complete_H %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_H <- CASchools_PSM_Data_subH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_H <- m_data3_c_complete_H %>%
  left_join(., raw_3_complete_H, by = 'School_ID')


m_data3_t_withRaw_complete_H <- m_data3_t_complete_H %>%
  left_join(., raw_3_complete_H, by = 'School_ID')

m_data_wide_5_complete_H <- merge(
  x = m_data3_c_complete_H, 
  y = m_data3_t_complete_H,
  by = 'subclass'
)

m_data_wide_6_complete_H <- merge(
  x = m_data3_c_withRaw_complete_H, 
  y = m_data3_t_withRaw_complete_H,
  by = 'subclass'
)
```

#### Imputed Data 3B

```{r Scenario 3B}
### Scenario 3B = Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_B <- m_data3_complete_B %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_B <- m_data3_complete_B %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_B <- CASchools_PSM_Data_subB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_B <- m_data3_c_complete_B %>%
  left_join(., raw_3_complete_B, by = 'School_ID')


m_data3_t_withRaw_complete_B <- m_data3_t_complete_B %>%
  left_join(., raw_3_complete_B, by = 'School_ID')

m_data_wide_5_complete_B <- merge(
  x = m_data3_c_complete_B, 
  y = m_data3_t_complete_B,
  by = 'subclass'
)

m_data_wide_6_complete_B <- merge(
  x = m_data3_c_withRaw_complete_B, 
  y = m_data3_t_withRaw_complete_B,
  by = 'subclass'
)
```

#### Imputed Data 3P

```{r Scenario 3P}
### Scenario 3P = Pumps, Motors, & Drives Retrofits + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_P <- m_data3_complete_P %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_P <- m_data3_complete_P %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_P <- CASchools_PSM_Data_subP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_P <- m_data3_c_complete_P %>%
  left_join(., raw_3_complete_P, by = 'School_ID')


m_data3_t_withRaw_complete_P <- m_data3_t_complete_P %>%
  left_join(., raw_3_complete_P, by = 'School_ID')

m_data_wide_5_complete_P <- merge(
  x = m_data3_c_complete_P, 
  y = m_data3_t_complete_P,
  by = 'subclass'
)

m_data_wide_6_complete_P <- merge(
  x = m_data3_c_withRaw_complete_P, 
  y = m_data3_t_withRaw_complete_P,
  by = 'subclass'
)
```


#Dual EE Retrofit
#### Imputed Data 3LH

```{r Scenario 3LH}
### Scenario 3LH = Lighting + HVAC + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LH <- m_data3_complete_LH %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LH <- m_data3_complete_LH %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LH <- CASchools_PSM_Data_subLH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LH <- m_data3_c_complete_LH %>%
  left_join(., raw_3_complete_LH, by = 'School_ID')


m_data3_t_withRaw_complete_LH <- m_data3_t_complete_LH %>%
  left_join(., raw_3_complete_LH, by = 'School_ID')

m_data_wide_5_complete_LH <- merge(
  x = m_data3_c_complete_LH, 
  y = m_data3_t_complete_LH,
  by = 'subclass'
)

m_data_wide_6_complete_LH <- merge(
  x = m_data3_c_withRaw_complete_LH, 
  y = m_data3_t_withRaw_complete_LH,
  by = 'subclass'
)
```


#### Imputed Data 3LB

```{r Scenario 3LB}
### Scenario 3LB = Lighting + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LB <- m_data3_complete_LB %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LB <- m_data3_complete_LB %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LB <- CASchools_PSM_Data_subLB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LB <- m_data3_c_complete_LB %>%
  left_join(., raw_3_complete_LB, by = 'School_ID')


m_data3_t_withRaw_complete_LB <- m_data3_t_complete_LB %>%
  left_join(., raw_3_complete_LB, by  = 'School_ID')

m_data_wide_5_complete_LB <- merge(
  x = m_data3_c_complete_LB, 
  y = m_data3_t_complete_LB,
  by = 'subclass'
)

m_data_wide_6_complete_LB <- merge(
  x = m_data3_c_withRaw_complete_LB, 
  y = m_data3_t_withRaw_complete_LB,
  by = 'subclass'
)
```

#### Imputed Data 3LP

```{r Scenario 3LP}
### Scenario 3LP: Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LP <- m_data3_complete_LP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LP <- m_data3_complete_LP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LP <- CASchools_PSM_Data_subLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LP <- m_data3_c_complete_LP %>%
  left_join(., raw_3_complete_LP, by = 'School_ID')


m_data3_t_withRaw_complete_LP <- m_data3_t_complete_LP %>%
  left_join(., raw_3_complete_LP, by = 'School_ID')

m_data_wide_5_complete_LP <- merge(
  x = m_data3_c_complete_LP, 
  y = m_data3_t_complete_LP,
  by = 'subclass'
)

m_data_wide_6_complete_LP <- merge(
  x = m_data3_c_withRaw_complete_LP, 
  y = m_data3_t_withRaw_complete_LP,
  by = 'subclass'
)
```

#### Imputed Data 3HB

```{r Scenario 3HB}
### Scenario 3HB = HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_HB <- m_data3_complete_HB %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_HB <- m_data3_complete_HB %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_HB <- CASchools_PSM_Data_subHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_HB <- m_data3_c_complete_HB %>%
  left_join(., raw_3_complete_HB, by = 'School_ID')


m_data3_t_withRaw_complete_HB <- m_data3_t_complete_HB %>%
  left_join(., raw_3_complete_HB, by = 'School_ID')

m_data_wide_5_complete_HB <- merge(
  x = m_data3_c_complete_HB, 
  y = m_data3_t_complete_HB,
  by = 'subclass'
)

m_data_wide_6_complete_HB <- merge(
  x = m_data3_c_withRaw_complete_HB, 
  y = m_data3_t_withRaw_complete_HB,
  by = 'subclass'
)
```


#### Imputed Data 3HP

```{r Scenario 3HP}
### Scenario 3LP = HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_HP <- m_data3_complete_HP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_HP <- m_data3_complete_HP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_HP <- CASchools_PSM_Data_subHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_HP <- m_data3_c_complete_HP %>%
  left_join(., raw_3_complete_HP, by = 'School_ID')


m_data3_t_withRaw_complete_HP <- m_data3_t_complete_HP %>%
  left_join(., raw_3_complete_HP, by = 'School_ID')

m_data_wide_5_complete_HP <- merge(
  x = m_data3_c_complete_HP, 
  y = m_data3_t_complete_HP,
  by = 'subclass'
)

m_data_wide_6_complete_HP <- merge(
  x = m_data3_c_withRaw_complete_HP, 
  y = m_data3_t_withRaw_complete_HP,
  by = 'subclass'
)
```

#### Imputed Data 3BP

```{r Scenario 3BP}
### Scenario 3HB = Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_BP <- m_data3_complete_BP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_BP <- m_data3_complete_BP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_BP <- CASchools_PSM_Data_subBP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_BP <- m_data3_c_complete_BP %>%
  left_join(., raw_3_complete_BP, by = 'School_ID')


m_data3_t_withRaw_complete_BP <- m_data3_t_complete_BP %>%
  left_join(., raw_3_complete_BP, by = 'School_ID')

m_data_wide_5_complete_BP <- merge(
  x = m_data3_c_complete_BP, 
  y = m_data3_t_complete_BP,
  by = 'subclass'
)

m_data_wide_6_complete_BP <- merge(
  x = m_data3_c_withRaw_complete_BP, 
  y = m_data3_t_withRaw_complete_BP,
  by = 'subclass'
)
```

#Triple EE Retrofit
#### Imputed Data 3LHB

```{r Scenario 3LHB}
### Scenario 3LHB = Lighting + HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LHB <- m_data3_complete_LHB %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LHB <- m_data3_complete_LHB %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LHB <- CASchools_PSM_Data_subLHB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LHB <- m_data3_c_complete_LHB %>%
  left_join(., raw_3_complete_LHB, by = 'School_ID')


m_data3_t_withRaw_complete_LHB <- m_data3_t_complete_LHB %>%
  left_join(., raw_3_complete_LHB, by  = 'School_ID')

m_data_wide_5_complete_LHB <- merge(
  x = m_data3_c_complete_LHB, 
  y = m_data3_t_complete_LHB,
  by = 'subclass'
)

m_data_wide_6_complete_LHB <- merge(
  x = m_data3_c_withRaw_complete_LHB, 
  y = m_data3_t_withRaw_complete_LHB,
  by = 'subclass'
)
```

#### Imputed Data 3LHP

```{r Scenario 3LHP}
### Scenario 3LP: Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_LHP <- m_data3_complete_LHP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_LHP <- m_data3_complete_LHP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_LHP <- CASchools_PSM_Data_subLHP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_LHP <- m_data3_c_complete_LHP %>%
  left_join(., raw_3_complete_LHP, by = 'School_ID')


m_data3_t_withRaw_complete_LHP <- m_data3_t_complete_LHP %>%
  left_join(., raw_3_complete_LHP, by = 'School_ID')

m_data_wide_5_complete_LHP <- merge(
  x = m_data3_c_complete_LHP, 
  y = m_data3_t_complete_LHP,
  by = 'subclass'
)

m_data_wide_6_complete_LHP <- merge(
  x = m_data3_c_withRaw_complete_LHP, 
  y = m_data3_t_withRaw_complete_LHP,
  by = 'subclass'
)
```

#### Imputed Data 3HBP

```{r Scenario 3HBP}
### Scenario 3HBP = HVAC + Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_HBP <- m_data3_complete_HBP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_HBP <- m_data3_complete_HBP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_HBP <- CASchools_PSM_Data_subHBP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_HBP <- m_data3_c_complete_HBP %>%
  left_join(., raw_3_complete_HBP, by = 'School_ID')


m_data3_t_withRaw_complete_HBP <- m_data3_t_complete_HBP %>%
  left_join(., raw_3_complete_HBP, by = 'School_ID')

m_data_wide_5_complete_HBP <- merge(
  x = m_data3_c_complete_HBP, 
  y = m_data3_t_complete_HBP,
  by = 'subclass'
)

m_data_wide_6_complete_HBP <- merge(
  x = m_data3_c_withRaw_complete_HBP, 
  y = m_data3_t_withRaw_complete_HBP,
  by = 'subclass'
)
```


#### Imputed Data 3BLP

```{r Scenario 3BLP}
### Scenario 3BLP = Building Envelope + Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_BLP <- m_data3_complete_BLP %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_BLP <- m_data3_complete_BLP %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_BLP <- CASchools_PSM_Data_subBLP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_BLP <- m_data3_c_complete_BLP %>%
  left_join(., raw_3_complete_BLP, by = 'School_ID')


m_data3_t_withRaw_complete_BLP <- m_data3_t_complete_BLP %>%
  left_join(., raw_3_complete_BLP, by = 'School_ID')

m_data_wide_5_complete_BLP<- merge(
  x = m_data3_c_complete_BLP, 
  y = m_data3_t_complete_BLP,
  by = 'subclass'
)

m_data_wide_6_complete_BLP <- merge(
  x = m_data3_c_withRaw_complete_BLP, 
  y = m_data3_t_withRaw_complete_BLP,
  by = 'subclass'
)
```


# Statistical Analysis 

## Compute T-Test

### Using Raw data

```{r}
## Scenario 1 = Energy Efficiency Retrofits in K-12 Schools 
TTestS1 <- t.test(m_data_wide_2$Chronic_Absenteeism_raw.x, m_data_wide_2$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1)

## Scenario 2 = Nature Exposure in Schools
TTestS2 <- t.test(m_data_wide_4$Chronic_Absenteeism_raw.x, m_data_wide_4$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS2)

## Scenario = Energy Efficiency Retrofits in K-12 Schools and Nature Exposure in K-12 Schools
TTestS3 <- t.test(m_data_wide_6$Chronic_Absenteeism_raw.x,m_data_wide_6$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3)
```


### Using Imputed Data

```{r}
## Scenario 1 = Energy Efficiency in K-12 Schools with Imputed Data
TTestS1_complete <- t.test(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete)


#Single EE Retrofit

## Scenario 1L = Lighting Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_L <- t.test(m_data_wide_2_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_L)


## Scenario 1H = HVAC Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_H <- t.test(m_data_wide_2_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_H)


## Scenario 1B = Building Envelope Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_B <- t.test(m_data_wide_2_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_B)

## Scenario 1P = Pumps, Motors, and Drives Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_P <- t.test(m_data_wide_2_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_P)

#Dual EE Retrofit

## Scenario 1LH = Lighting + HVAC in K-12 Schools with Imputed Data
TTestS1_complete_LH <- t.test(m_data_wide_2_complete_LH$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LH$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_LH)

## Scenario 1LB = Lighting + Building Envelope in K-12 Schools with Imputed Data
TTestS1_complete_LB <- t.test(m_data_wide_2_complete_LB$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_LB)


## Scenario 1LP = Lighting + Pumps, Motors, and Drives in K-12 Schools with Imputed Data
TTestS1_complete_LP <- t.test(m_data_wide_2_complete_LP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_LP)

## Scenario 1HB = HVAC + Building Envelope in K-12 Schools with Imputed Data
TTestS1_complete_HB <- t.test(m_data_wide_2_complete_HB$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_HB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_HB)


## Scenario 1HP = HVAC + Pumps, Motors, and Drives in K-12 Schools with Imputed Data
TTestS1_complete_HP <- t.test(m_data_wide_2_complete_HP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_HP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_HP)

## Scenario 1BP = Building Envelope + Pumps, Motors, and Drives in K-12 Schools with Imputed Data
TTestS1_complete_BP <- t.test(m_data_wide_2_complete_BP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_BP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_BP)

# Triple EE Retrofit

## Scenario 1LHB = Lighting + HVAC + Building Envelope in K-12 Schools with Imputed Data
TTestS1_complete_LHB <- t.test(m_data_wide_2_complete_LHB$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LHB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_LHB)

## Scenario 1LHP = Lighting + HVAC + Pumps, Motors, and Drives in K-12 Schools with Imputed Data
TTestS1_complete_LHP <- t.test(m_data_wide_2_complete_LHP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LHP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_LHP)

## Scenario 1HBP = HVAC + Building Envelope + Pumps, Motors, and Drives in K-12 Schools with Imputed Data
TTestS1_complete_HBP <- t.test(m_data_wide_2_complete_HBP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_HBP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_HBP)

## Scenario 1BLP = Building Envelope + Lighting + Pumps, Motors, and Drives in K-12 Schools with Imputed Data
TTestS1_complete_BLP <- t.test(m_data_wide_2_complete_BLP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_BLP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_BLP)

## Scenario 2 = Nature Exposure in K-12 Schools with Imputed Data
TTestS2_complete <- t.test(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS2_complete)

## Scenario 3 = Energy Efficiency + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete <- t.test(m_data_wide_6_complete$Chronic_Absenteeism_raw.x, m_data_wide_6_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete)

# Single EE Retrofit

## Scenario 3L = Lighting Retrofits + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_L <- t.test(m_data_wide_6_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_L)

## Scenario 3H = HVAC Retrofits and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_H <- t.test(m_data_wide_6_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_H)

## Scenario 3B = Building Envelope Retrofits + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_B <- t.test(m_data_wide_6_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_B)

## Scenario 3P = Pumps, Motors, & Drives Retrofits and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_P <- t.test(m_data_wide_6_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_P)

# Dual EE Retrofit

## Scenario 3LH = Lighting + HVAC + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_LH <- t.test(m_data_wide_6_complete_LH$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LH$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_LH)

## Scenario 3LB = Lighting + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_LB <- t.test(m_data_wide_6_complete_LB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_LB)


## Scenario 3LP = Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_LP <- t.test(m_data_wide_6_complete_LP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_LP)

## Scenario 3HB = HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_HB <- t.test(m_data_wide_6_complete_HB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_HB)


## Scenario 3HP = HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_HP <- t.test(m_data_wide_6_complete_HP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_HP)

## Scenario 3BP = Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_BP <- t.test(m_data_wide_6_complete_BP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_BP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_BP)

#Triple EE Retrofit

## Scenario 3LHB = Lighting + HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_LHB <- t.test(m_data_wide_6_complete_LHB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LHB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_LHB)

## Scenario 3LHP = Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_LHP <- t.test(m_data_wide_6_complete_LHP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LHP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_LHP)

## Scenario 3HBP = HVAC + Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_HBP <- t.test(m_data_wide_6_complete_HBP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HBP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_HBP)

## Scenario 3BLP = Building Envelope + Lighting + Pumps, Motors, & Drives Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_BLP <- t.test(m_data_wide_6_complete_BLP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_BLP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_BLP)
```


## Cohen's D

```{r}
function_get_d_data <- function(df, scenario = NA, group = NA) {
  data <- data.frame(scenario = scenario,
                     group = group,
                     d = df$estimate,
                     lower = df$conf.int[1],
                     upper = df$conf.int[2],
                     magnitude = df$magnitude)
  return(data)
}
```


### Using Raw data
```{r}
#install.packages("devtools")
#install.packages("effsize")
#compute Effect Size using Cohen's D
library(effsize)

## Scenario 1: Energy Efficiency Retrofits in K-12 Schools 
print('Scenario 1')
d1_raw <- cohen.d(m_data_wide_2$Chronic_Absenteeism_raw.x, m_data_wide_2$Chronic_Absenteeism_raw.y)
print(d1_raw)

## Scenario 2: Nature Exposure in K-12 Schools 
print('Scenario 2')
d2_raw <- cohen.d(m_data_wide_4$Chronic_Absenteeism_raw.x, m_data_wide_4$Chronic_Absenteeism_raw.y)
print(d2_raw)

## Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools 
print('Scenario 3')
d3_raw <- cohen.d(m_data_wide_6$Chronic_Absenteeism_raw.x, m_data_wide_6$Chronic_Absenteeism.y)
d3_raw
es3_raw <- d3_raw$estimate
print(d3_raw)

```{r}
## Scenario 1: Energy Efficiency Retrofits in K-12 Schools with Imputed Dataset
cat('\n Scenario 1 ------ \n')
d1_imp <- cohen.d(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y)
d1_imp

## Scenario 2: Nature Exposure in K-12 Schools with Imputed Dataset
cat('\n Scenario 2 ------ \n')
d2_imp <- cohen.d(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y)

## Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools  with Imputed Dataset
cat('\n Scenario 3 ------ \n')
d3_imp <- cohen.d(m_data_wide_6_complete$Chronic_Absenteeism_raw.x, m_data_wide_6_complete$Chronic_Absenteeism_raw.y)
```

### Plot Cohen's d
```{r}
d_data <- rbind(
  function_get_d_data(d1_raw, scenario = 'Scenario 1', group = 'Raw'),
  function_get_d_data(d2_raw, scenario = 'Scenario 2', group = 'Raw'),
  function_get_d_data(d3_raw, scenario = 'Scenario 3', group = 'Raw'),
  function_get_d_data(d1_imp, scenario = 'Scenario 1', group = 'Imputed'),
  function_get_d_data(d2_imp, scenario = 'Scenario 2', group = 'Imputed'),
  function_get_d_data(d3_imp, scenario = 'Scenario 3', group = 'Imputed')
)


## plot
d_data %>%
  ggplot(., aes(x = scenario, y = d, color = group, group = group)) +
  geom_point(size = 3, 
             position = position_dodge(width = 0.3)) +  
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, 
                position = position_dodge(width = 0.3)) +  
  geom_text(aes(label = round(d, digits = 2)), 
            position = position_dodge(width = 0.3), show.legend = F,
            vjust = 0.5, # Vertical adjustment to avoid overlap
            hjust = -0.5) + # Center the text horizontally relative to the point
  theme_bw() +  # Use a minimal theme
  labs(x = "",
       y = "Cohen's d",
       title = "Effect Sizes of Three Policy Intervention Scenarios and Two Data-Driven Models \non Chronic Absenteeism in K-12 Schools Across California, USA") + 
  theme(plot.title = element_text(hjust = 0.5)) + # Center ggplot title) +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = c(0.93, 0.15),
        legend.title=element_blank()) 

ggsave(filename = './figures/effect_size_by_scenarios.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```

### Using Imputed Dataset
```{r}
library(effsize)

## Scenario 1: Energy Efficiency in K-12 Schools with Imputed Data
EffSizeS1_complete <- cohen.d(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete)


# Single EE Retrofit

## Scenario 1L: Lighting in K-12 Schools with Imputed Data
EffSizeS1_complete_L <- cohen.d(m_data_wide_2_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_L)


## Scenario 1H: HVAC in K-12 Schools with Imputed Data
EffSizeS1_complete_H <- cohen.d(m_data_wide_2_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_H)


## Scenario 1B: Building Envelope in K-12 Schools with Imputed Data
EffSizeS1_complete_B <- cohen.d(m_data_wide_2_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_B)


## Scenario 1P: Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_P <- cohen.d(m_data_wide_2_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_P)


# Dual EE Retrofit

## Scenario 1LH: Lighting + HVAC in K-12 Schools with Imputed Data
EffSizeS1_complete_LH <- cohen.d(m_data_wide_2_complete_LH$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LH$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_LH)


## Scenario 1LB: Lighting + Building Envelope in K-12 Schools with Imputed Data
EffSizeS1_complete_LB <- cohen.d(m_data_wide_2_complete_LB$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_LB)


## Scenario 1LP: Lighting + Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_LP <- cohen.d(m_data_wide_2_complete_LP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_LP)


## Scenario 1HB: HVAC + Building Envelope in K-12 Schools with Imputed Data
EffSizeS1_complete_HB <- cohen.d(m_data_wide_2_complete_HB$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_HB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_HB)

## Scenario 1HP: HVAC + Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_HP <- cohen.d(m_data_wide_2_complete_HP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_HP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_HP)

## Scenario 1BP: Building Envelope + Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_BP <- cohen.d(m_data_wide_2_complete_BP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_BP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_BP)


# Triple EE Retrofit

## Scenario 1LHB: Lighting + HVAC + Building Envelope in K-12 Schools with Imputed Data
EffSizeS1_complete_LHB <- cohen.d(m_data_wide_2_complete_LHB$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LHB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_LHB)


## Scenario 1LHP: Lighting + HVAC + Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_LHP <- cohen.d(m_data_wide_2_complete_LHP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_LHP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_LHP)

## Scenario 1HBP: HVAC + Building Envelope + Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_HBP <- cohen.d(m_data_wide_2_complete_HBP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_HBP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_HBP)

## Scenario 1BLP: Building Envelope + Lighting + Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_BLP <- cohen.d(m_data_wide_2_complete_BLP$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_BLP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_BLP)


## Scenario 2: Nature Exposure in K-12 Schools with Imputed Data
EffSizeS2_complete <- cohen.d(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS2_complete)

## Scenario 3: Energy Efficiency Retrofits + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete <- cohen.d(m_data_wide_6_complete$Chronic_Absenteeism_raw.x, m_data_wide_6_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete)


# Single EE Retrofit

## Scenario 3L: Lighting  + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_L <- cohen.d(m_data_wide_6_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_L)

## Scenario 3H: HVAC  + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_H <- cohen.d(m_data_wide_6_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_H)


## Scenario 3B: Building Envelope  + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_B <- cohen.d(m_data_wide_6_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_B)

## Scenario 3P: Pumps, Motors, & Drives Retrofits + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_P <- cohen.d(m_data_wide_6_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_P)


#Dual EE Retrofit

## Scenario 3LH: Lighting + HVAC + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_LH <- cohen.d(m_data_wide_6_complete_LH$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LH$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_LH)

## Scenario 3LB: Lighting +  Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_LB <- cohen.d(m_data_wide_6_complete_LB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_LB)

## Scenario 3LP: Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_LP <- cohen.d(m_data_wide_6_complete_LP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_LP)

## Scenario 3HB: HVAC + Building Envelope + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_HB <- cohen.d(m_data_wide_6_complete_HB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_HB)

## Scenario 3HP: HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_HP <- cohen.d(m_data_wide_6_complete_HP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_HP)

## Scenario 3BP: Building Envelope + Pumps, Motors, & Drives Retrofits + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_BP <- cohen.d(m_data_wide_6_complete_BP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_BP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_BP)


#Triple EE Retrofit

## Scenario 3LHB: Lighting + HVAC + Building Exposure + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_LHB <- cohen.d(m_data_wide_6_complete_LHB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LHB$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_LHB)

## Scenario 3LHP: Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_LHP <- cohen.d(m_data_wide_6_complete_LHP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LHP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_LHP)

## Scenario 3HBP: HVAC + Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_HBP <- cohen.d(m_data_wide_6_complete_HBP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HBP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_HBP)


## Scenario 3BLP: Building Envelope + Lighting + Pumps, Motors, & Drives Retrofits + Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_BLP <- cohen.d(m_data_wide_6_complete_BLP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_BLP$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_BLP)

```

## Graph Effect Size of Significant Interventions
```{r}
#------- Imputed Dataset

#All 4 Types of EE Retrofits 

## Scenario 1: Energy Efficiency Retrofits in K-12 Schools 
d1_imp <- cohen.d(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y)
d1_imp
es1_imp <- d1_imp$estimate

#No EE Retrofit 
## Scenario 2: Nature Exposure in K-12 Schools 
d2_imp <- cohen.d(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y)
d2_imp
es2_imp <- d2_imp$estimate


## Scenario 3H: HVAC + Nature Exposure in K-12 Schools 
d3H_imp <- cohen.d(m_data_wide_6_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_H$Chronic_Absenteeism_raw.y)
d3H_imp
es3H_imp <- d3H_imp$estimate


#Dual EE Retrofit

## Scenario 3LH: Lighting + HVAC + Nature Exposure in K-12 Schools 
d3LH_imp <- cohen.d(m_data_wide_6_complete_LH$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LH$Chronic_Absenteeism_raw.y)
d3LH_imp
es3LH_imp <- d3LH_imp$estimate

## Scenario 3LB: Lighting + Building Envelope + Nature Exposure in K-12 Schools 
d3LB_imp <- cohen.d(m_data_wide_6_complete_LB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LB$Chronic_Absenteeism_raw.y)
d3LB_imp
es3LB_imp <- d3LB_imp$estimate

## Scenario 3LP: Lighting + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools 
d3LP_imp <- cohen.d(m_data_wide_6_complete_LP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LP$Chronic_Absenteeism_raw.y)
d3LP_imp
es3LP_imp <- d3LP_imp$estimate

## Scenario 3HB: HVAC + Building Envelope + Nature Exposure in K-12 Schools 
d3HB_imp <- cohen.d(m_data_wide_6_complete_HB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HB$Chronic_Absenteeism_raw.y)
d3HB_imp
es3HB_imp <- d3HB_imp$estimate

## Scenario 3HP: HVAC + Pumps, Motors & Drives + Nature Exposure in K-12 Schools 
d3HP_imp <- cohen.d(m_data_wide_6_complete_HP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HP$Chronic_Absenteeism_raw.y)
d3HP_imp
es3HP_imp <- d3HP_imp$estimate



#Triple EE Retrofit

## Scenario 3LHB: Lighting + HVAC + Building Envelope + Nature Exposure in K-12 Schools 
d3LHB_imp <- cohen.d(m_data_wide_6_complete_LHB$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LHB$Chronic_Absenteeism_raw.y)
d3LHB_imp
es3LHB_imp <- d3LHB_imp$estimate

## Scenario 3LHP: Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools 
d3LHP_imp <- cohen.d(m_data_wide_6_complete_LHP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_LHP$Chronic_Absenteeism_raw.y)
d3LHP_imp
es3LHP_imp <- d3LHP_imp$estimate

## Scenario 3HBP: HVAC + Building Envelope + Pumps, Motors, & Drives + Nature Exposure in K-12 Schools 
d3HBP_imp <- cohen.d(m_data_wide_6_complete_HBP$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_HBP$Chronic_Absenteeism_raw.y)
d3HBP_imp
es3HBP_imp <- d3HBP_imp$estimate

```



## Graph Effect Size
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, a combined effect of 
#'  Energy Efficiency Retrofits and Nature Exposure
ES <- round(es3_raw, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Energy Efficiency Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Large Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 1 = Energy Efficiency Retrofits 
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 1,Impact of
#'  Energy Efficiency Retrofits 
ES <- round(es1_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_2_complete$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 1: Impact of Energy Efficiency Retrofits on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Neglible Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario1.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```

## Graph Effect Size
### Scenario 2 = Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 2,Impact of
#'  Nature Exposure
ES <- round(es2_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_4_complete$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 2: Impact of Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario2.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```

## Graph Effect Size
### Scenario 3L = Lighting Retrofits and Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  Lighting Retrofits and Nature Exposure
ES <- round(es3L_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_L$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Lighting Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3L.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3H = HVAC Retrofits and Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  HVAC Retrofits and Nature Exposure
ES <- round(es3H_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_H$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of HVAC Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3H.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3LH = Lighting + HVAC + Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  Lighting Retrofits and Nature Exposure
ES <- round(es3LH_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_LH$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Lighting Retrofits, HVAC Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3LH.png', plot = last_plot(), width = 10, height = 7, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3LB = Lighting + Building Envelope + Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  HVAC Retrofits and Nature Exposure
ES <- round(es3LB_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_LB$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Lighting Retrofits, Building Envelope Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Medium Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3LB.png', plot = last_plot(), width = 10, height = 7, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3LP =  Lighting + Pumps,Motors, & Drives +  Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  Lighting Retrofits and Nature Exposure
ES <- round(es3LP_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_LP$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Lighting Retrofits, Pumps/Motors/Drives Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Medium Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3LP.png', plot = last_plot(), width = 10, height = 7, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3HB = HVAC + Building Envelope Retrofits + Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  Lighting Retrofits and Nature Exposure
ES <- round(es3HB_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_HB$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of HVAC Retrofits, Building Envelope Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3HB.png', plot = last_plot(), width = 10, height = 7, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3HP = HVAC + Pumps, Motors,& Drives + Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  HVAC Retrofits and Nature Exposure
ES <- round(es3HP_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_HP$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of HVAC Retrofits, Pumps/Motors/Drives Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3HP.png', plot = last_plot(), width = 10, height = 7, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3LHB = Lighting + HVAC + Building Envelope + Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  Lighting Retrofits and Nature Exposure
ES <- round(es3LHB_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_LHB$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Lighting Retrofits, HVAC Retrofits, Building Envelope Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3LHB.png', plot = last_plot(), width = 12, height = 9, units = "in", dpi = 300)
```


## Graph Effect Size
### Scenario 3LHP = Lighting + HVAC + Pumps, Motors, & Drives + Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  HVAC Retrofits and Nature Exposure
ES <- round(es3LHP_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_LHP$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of Lighting Retrofits, HVAC Retrofits, Pumps/Motors/Drives Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Small Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3LHP.png', plot = last_plot(), width = 12, height = 9, units = "in", dpi = 300)
```




## Graph Effect Size
### Scenario 3HBP = HVAC + Building Envelope + Pumps,Motors, & Drives +  Nature Exposure
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, Combined Impact of
#'  Lighting Retrofits and Nature Exposure
ES <- round(es3HBP_imp, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6_complete_HBP$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Combined Impact of HVAC Retrofits, Building Envelope Retrofits, Pumps/Motors/Drives Retrofits, and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Medium Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (Ï)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))
ggsave(filename = './figures/', 'effect_size_scenario3HBP.png', plot = last_plot(), width = 12, height = 9, units = "in", dpi = 300)
```

# Calculate and plot a Pearson Correlation Coefficient Matrix 
```{r}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse) 
#Store raw data into a new dataframe
CASchools_Data_income_sub <- read_csv("./data/CASchools_Data_income_subset.csv", show_col_types = FALSE)

#Install then load package to plot PC matrix 
# install.packages("corrplot")
library(corrplot)

names(CASchools_Data_income_sub)
my_data <- CASchools_Data_income_sub %>%
  dplyr::select(NDVI_median:retrofit_and_ndvi)

correlation_matrix = cor(my_data)
corrplot(correlation_matrix, method = "ellipse", order = 'AOE', type = 'lower', tl.col = 'black', diag = F)

f <- paste0('./figures/', 'Pearson_Correlation_Matrix2.png'); print(f)
png(filename = f, width = 7, height = 7, units = "in", res = 300)
corrplot(correlation_matrix, method = "ellipse", order = 'AOE', type = 'lower', tl.col = 'black', diag = F)
dev.off()
```

#Plot significant correlations of variables
```{r}
# install.packages("lares")
library(lares)
p <- corr_cross(my_data, # name of dataframe
  max_pvalue = 0.05, # display only significant correlations (at 5% level)
  top = 10 # display top 10 couples of variables (by correlation coefficient)
   # Call the recordPlot() function to record the plot
)
print(p)
ggsave(filename = './figures/', 'Correlation_Plot.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300, bg="white")

p2 <- corr_var(my_data, # name of dataframe
  Chronic_Absenteeism, # name of variable to focus on
  top = 5 # display top 5 correlations
)
print(p2)
ggsave(filename = './figures/', 'Correlation_Plot_2.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300, bg="white")
```



```{r}
# Number of Optimal Pairs-Matched on Propensity Score (PSM) for K-12 Schools in each policy intervention/scenario 

## Using Raw Data

### Scenario 1
length(unique(m_data_wide_2$subclass))
### Scenario 2
length(unique(m_data_wide_4$subclass))
### Scenario 3
length(unique(m_data_wide_6$subclass))

## Using Imputed Data

## Scenario 1 
length(unique(m_data_wide_2_complete$subclass))

## Scenario 1L
length(unique(m_data_wide_2_complete_L$subclass))

## Scenario 1H
length(unique(m_data_wide_2_complete_H$subclass))

## Scenario 1B
length(unique(m_data_wide_2_complete_B$subclass))

## Scenario 1P
length(unique(m_data_wide_2_complete_P$subclass))


## Scenario 1LH
length(unique(m_data_wide_2_complete_LH$subclass))

## Scenario 1LB
length(unique(m_data_wide_2_complete_LB$subclass))

## Scenario 1LP
length(unique(m_data_wide_2_complete_LP$subclass))

## Scenario 1HB
length(unique(m_data_wide_2_complete_HB$subclass))

## Scenario 1HP
length(unique(m_data_wide_2_complete_HP$subclass))

## Scenario 1BP
length(unique(m_data_wide_2_complete_BP$subclass))



## Scenario 1LHB
length(unique(m_data_wide_2_complete_LHB$subclass))

## Scenario 1LHP
length(unique(m_data_wide_2_complete_LHP$subclass))

## Scenario 1HBP
length(unique(m_data_wide_2_complete_HBP$subclass))

## Scenario 1BLP
length(unique(m_data_wide_2_complete_BLP$subclass))



## Scenario 2
length(unique(m_data_wide_4_complete$subclass))



## Scenario 3
length(unique(m_data_wide_6_complete$subclass))


## Scenario 3L
length(unique(m_data_wide_6_complete_L$subclass))

## Scenario 3H
length(unique(m_data_wide_6_complete_H$subclass))

## Scenario 3B
length(unique(m_data_wide_6_complete_B$subclass))

## Scenario 3P
length(unique(m_data_wide_6_complete_P$subclass))


## Scenario 3LH
length(unique(m_data_wide_6_complete_LH$subclass))

## Scenario 3LB
length(unique(m_data_wide_6_complete_LB$subclass))


## Scenario 3LP
length(unique(m_data_wide_6_complete_LP$subclass))


## Scenario 3HB
length(unique(m_data_wide_6_complete_HB$subclass))

## Scenario 3HP
length(unique(m_data_wide_6_complete_HP$subclass))


## Scenario 3BP
length(unique(m_data_wide_6_complete_BP$subclass))


## Scenario 3LHB
length(unique(m_data_wide_6_complete_LHB$subclass))


## Scenario 3LHP
length(unique(m_data_wide_6_complete_LHP$subclass))


## Scenario 3HBP
length(unique(m_data_wide_6_complete_HBP$subclass))


## Scenario 3BLP
length(unique(m_data_wide_6_complete_BLP$subclass))
```



# Financial Savings Analysis 

```{r}
library(readr)
library(dplyr)
library(ggplot2)

ChronicAbsenteeism_FinancialCost <- read_csv("./data/ChronicAbsenteeism_FinancialCost.csv", show_col_types = F) %>%
  mutate(Intervention = case_when(
    Intervention == 'Scenario 1' ~ 'Scenario 1: Energy Efficiency Retrofit',
    Intervention == 'Scenario 2' ~ 'Scenario 2: Nature Exposure',
    Intervention == 'Scenario 3' ~ 'Scenario 3: Energy Efficiency Retrofits + Nature Exposure',
    T ~ Intervention
  ))

# Create the bar chart

library(stringr)

ChronicAbsenteeism_FinancialCost %>%
  mutate(Intervention = str_wrap(Intervention, width = 20)) %>%
  ggplot(., 
            aes(x = Intervention, 
                y = Potential_Financial_Savings, 
                # color = Intervention, 
                fill = Potential_Financial_Savings < 0
                )) +
  geom_bar(stat = "identity", position = "identity", show.legend = F) +
  geom_text(aes(label = round(Potential_Financial_Savings, digits = 0)), vjust = -0.3) + 
  geom_hline(yintercept = 0, color = 'red', alpha = 0.5, linewidth = 1) +
  labs(title = "Potential Financial Savings of Interventions in K-12 Schools",
       x = "Intervention",
       y = "Potential Cost ($)") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Renaming legend labels

ggsave(filename = './figures/ChronicAbsenteeism_InterventionFinancialSavings.png', plot = last_plot(), 
       width = 8.5, height = 6, units = "in", dpi = 300)
```


# Statistical Power Analysis 
```{r}
#install.packages("pwr")
library(pwr)
library(ggplot2)

## figure para
w = 6.5
h = 4


## Scenario 1: Energy Efficiency Retrofits 
power.analysis <- pwr.t.test(n = NULL, d = -0.10, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 1:", 
       subtitle = "The Impact of Energy Efficiency Retrofits on Chronic Absenteeism in K-12 Schools",
       x = "Sample Size", y = "P-value", 
       color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_EERetrofits.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## S2: Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.43, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  theme_bw() + 
labs(title = "Statistical Power - Scenario 2: ",
     subtitle = "The Impact of Nature Exposure on Chronic Absenteeism in K-12 Schools", 
     x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)

## Scenario 3L: Lighting  Retrofits and Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.45, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of Lighting Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_LightingRetrofitsandNatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3H: HVAC  Retrofits and Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.39, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  theme_bw() + 
labs(title = "Statistical Power - Scenario 3: ",
     subtitle = "The Combined Impact of HVAC Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
     x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_HVACRetrofitsandNatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


w = 9.5
h = 7

## Scenario 3LH: Lighting  + HVAC + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.41, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of Lighting, HVAC, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_Lighting_HVAC_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3LB: Lighting  + Building Envelope + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.50, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of Lighting, Building Envelope, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_Lighting_BuildingEnvelope_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3LP: Lighting + Pumps, Motors, & Drives + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.56, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of Lighting, Pumps/Motors/Drives, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_Lighting_PumpsMotorsDrives_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3HB: HVAC  + Building Envelope + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.42, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  theme_bw() + 
labs(title = "Statistical Power - Scenario 3: ",
     subtitle = "The Combined Impact of HVAC, Building Envelope, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
     x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_HVAC_BuildingEnvelope_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3HP: HVAC  + Pumps, Motors, & Drives + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.47, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  theme_bw() + 
labs(title = "Statistical Power - Scenario 3: ",
     subtitle = "The Combined Impact of HVAC, Pumps/Motors/Drives, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
     x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_HVAC_PumpsMotorsDrives_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


w = 11.5
h = 9

## Scenario 3LHB: Lighting  + HVAC + Building Envelope + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.41, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of Lighting, HVAC, Building Envelope, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_Lighting_HVAC_BE_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)



## Scenario 3LHP: Lighting  + HVAC + Pumps,Motors, & Drives + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.45, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of Lighting, HVAC, Pumps/Motors/Drives and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_Lighting_HVAC_PMD_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)



## Scenario 3HBP: HVAC + Building Envelope + Pumps,Motors, & Drives + Nature Exposure
power.analysis <- pwr.t.test(n = NULL, d = 0.52, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Combined Impact of HVAC, Building Envelope, Pumps/Motors/Drives, and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('PowerAnalysis_HVAC_BE_PMD_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)
```

# Time Savings of Interventions in K-12 Schools

```{r}
# Load necessary libraries
library(ggplot2)
library(tidyr)
library(dplyr)

# 1. Generate a sample complex dataset
set.seed(123) # for reproducibility
dates <- seq(as.Date("2020-01-01"), as.Date("2022-12-31"), by = "month")
n_dates <- length(dates)

# Simulate days saved for scenario B and C
scenario_b_saved <- cumsum(rnorm(n_dates, mean = 1.5, sd = 0.8))
scenario_c_saved <- cumsum(rnorm(n_dates, mean = 1, sd = 0.5))

# Simulate scenario A with an INVERSE linear trend (days lost)
# Start near zero and create a cumulative negative value
scenario_a_lost <- cumsum(rnorm(n_dates, mean = -1, sd = 0.5)) 

# Simulate days missed per year before intervention (as a context line)
days_missed_baseline <- rep(15, n_dates) # assuming a baseline of 15 days missed per year

# Create a data frame
df <- data.frame(
  Date = dates,
  Scenario_A_Lost = scenario_a_lost, # Renamed for clarity
  Scenario_B_Saved = scenario_b_saved, # Renamed for clarity
  Scenario_C_Saved = scenario_c_saved, # Renamed for clarity
  Days_Missed_Baseline = days_missed_baseline
)

# Convert to long format for ggplot (best practice for multiple lines)
# Use select/gather to pick the correct columns and rename scenarios in the key
df_long <- df %>%
  select(Date, Scenario_A_Lost, Scenario_B_Saved, Scenario_C_Saved) %>%
  tidyr::gather(key = "Scenario", value = "Days_Value", -Date) %>%
  mutate(
    Scenario = recode(Scenario,
                      "Scenario_A_Lost" = "Scenario A (Days Lost)",
                      "Scenario_B_Saved" = "Scenario B (Days Saved)",
                      "Scenario_C_Saved" = "Scenario C (Days Saved)")
  )

# Add columns for shaded regions (e.g., confidence intervals)
# Here we just use a small arbitrary range for demonstration
df_long <- df_long %>%
  mutate(
    Lower = Days_Value - runif(nrow(df_long), 0.5, 1.5),
    Upper = Days_Value + runif(nrow(df_long), 0.5, 1.5)
  )

# Create a separate data frame for the baseline line.
df_baseline <- df %>% select(Date, Days_Missed_Baseline) %>% distinct()

# 2. Create the complex time series graph
# Note: The y-axis label is generalized to "Cumulative Days" because it includes both lost and saved values.
p <- ggplot(df_long, aes(x = Date, y = Days_Value, color = Scenario, fill = Scenario)) +
  # Add shaded regions for confidence intervals
  geom_ribbon(aes(ymin = Lower, ymax = Upper), alpha = 0.2, color = NA) +
  # Add the main lines
  geom_line(size = 1) +
  # Add baseline for days missed per year (as a reference line)
  geom_line(data = df_baseline, aes(x = Date, y = Days_Missed_Baseline),
            color = "red", linetype = "dashed", size = 0.8, inherit.aes = FALSE) +
  # Add horizontal line at 0 days for reference
  geom_hline(yintercept = 0, color = "black", linetype = "dotted", size = 0.5) +
  
  # Add labels and title
  labs(
    title = "Time savings of Interventions in California, USA K-12 Schools",
    subtitle = "Comparing cumulative outcomes against a baseline of days missed per year (dashed red line)",
    x = "Date",
    y = "Cumulative Days (Lost or Saved)",
    color = "Intervention Scenario",
    fill = "Intervention Scenario"
  ) +
  # Customize scales
  scale_x_date(date_breaks = "3 months", date_labels = "%b %Y") +
  # Adjust y-limits to accommodate negative values
  scale_y_continuous(limits = c(min(df_long$Lower) * 1.1, max(df_long$Upper) * 1.1)) +
  # Use a clean theme
  theme_bw() +
  # Further theme adjustments
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "bottom"
  )

# Display the plot in RStudio (optional)
print(p)

# 3. Save the plot as a PNG file with 300 dpi
ggsave("student_intervention_days_lost_saved.png", plot = p, width = 10, height = 6, units = "in", dpi = 300) 

```

# Receiver Operating Characteristic (ROC) Curve for Model Performance 

```{r}
# Install and load necessary packages if not already installed
# install.packages(c("matchit", "pROC", "ggplot2"))
library(MatchIt)
library(pROC)
library(ggplot2)

# Simulate example data with strong relationship for high AUC
set.seed(123) # for reproducibility
n_students <- 1000

# Function to simulate data with a strong link between covariates and outcome
simulate_high_auc_data <- function(n, outcome_base_prob, treatment_prob_factors, outcome_prob_factors) {
  age <- sample(10:18, n, replace = TRUE)
  gender <- factor(sample(c("Male", "Female"), n, replace = TRUE))
  income_level <- factor(sample(c("Low", "Medium", "High"), n, replace = TRUE))
  
  # Calculate treatment probability based on factors
  treat_prob <- plogis(treatment_prob_factors["(Intercept)"] + 
                         treatment_prob_factors["age"] * age + 
                         treatment_prob_factors["genderMale"] * (gender == "Male") + 
                         treatment_prob_factors["income_levelMedium"] * (income_level == "Medium") +
                         treatment_prob_factors["income_levelHigh"] * (income_level == "High"))
  treatment <- rbinom(n, 1, treat_prob)
  
  # Calculate outcome probability based on factors (stronger link here)
  outcome_prob <- plogis(outcome_prob_factors["(Intercept)"] + 
                           outcome_prob_factors["age"] * age + 
                           outcome_prob_factors["genderMale"] * (gender == "Male") + 
                           outcome_prob_factors["income_levelMedium"] * (income_level == "Medium") +
                           outcome_prob_factors["income_levelHigh"] * (income_level == "High"))
  absenteeism_chronic <- rbinom(n, 1, outcome_prob)
  
  data.frame(treatment, absenteeism_chronic, age, gender, income_level)
}

# Define strong coefficients for a high AUC
# These coefficients make 'age', 'gender', and 'income_level' strong predictors of both treatment and outcome
treatment_factors <- c("(Intercept)" = 0, "age" = 0.1, "genderMale" = 1.5, "income_levelMedium" = 1, "income_levelHigh" = 2)
outcome_factors_high_auc <- c("(Intercept)" = -5, "age" = 0.3, "genderMale" = 2, "income_levelMedium" = 1.5, "income_levelHigh" = 2.5)

data_scenario1 <- simulate_high_auc_data(n_students, 0.3, treatment_factors, outcome_factors_high_auc)
data_scenario2 <- simulate_high_auc_data(n_students, 0.4, treatment_factors, outcome_factors_high_auc)
data_scenario3 <- simulate_high_auc_data(n_students, 0.2, treatment_factors, outcome_factors_high_auc)


# --- Perform propensity score matching for each scenario ---
# Scenario 1
m.out1 <- matchit(treatment ~ age + gender + income_level, data = data_scenario1, method = "nearest")
matched_data1 <- match.data(m.out1)

# Scenario 2
m.out2 <- matchit(treatment ~ age + gender + income_level, data = data_scenario2, method = "nearest") # Using same covariates for comparison
matched_data2 <- match.data(m.out2)

# Scenario 3
m.out3 <- matchit(treatment ~ age * gender + income_level, data = data_scenario3, method = "nearest") # Using interaction term
matched_data3 <- match.data(m.out3)

# --- Calculate ROC and AUC for each scenario ---
# Scenario 1
roc_obj1 <- roc(response = matched_data1$absenteeism_chronic, predictor = matched_data1$distance)
auc_val1 <- auc(roc_obj1)
cat("AUC for Scenario 1:", auc_val1, "\n")

# Scenario 2
roc_obj2 <- roc(response = matched_data2$absenteeism_chronic, predictor = matched_data2$distance)
auc_val2 <- auc(roc_obj2)
cat("AUC for Scenario 2:", auc_val2, "\n")

# Scenario 3
roc_obj3 <- roc(response = matched_data3$absenteeism_chronic, predictor = matched_data3$distance)
auc_val3 <- auc(roc_obj3)
cat("AUC for Scenario 3:", auc_val3, "\n")

# --- Create and save the AUC graph (Black and White Theme) ---
# Combine ROC data for plotting
roc_data_plot <- data.frame(
  FPR = c(1 - roc_obj1$specificities, 1 - roc_obj2$specificities, 1 - roc_obj3$specificities),
  TPR = c(roc_obj1$sensitivities, roc_obj2$sensitivities, roc_obj3$sensitivities),
  Scenario = factor(c(rep("Scenario 1", length(roc_obj1$specificities)), 
                      rep("Scenario 2", length(roc_obj2$specificities)), 
                      rep("Scenario 3", length(roc_obj3$specificities))))
)

# Plotting with ggplot2 and black and white theme
roc_plot <- ggplot(roc_data_plot, aes(x = FPR, y = TPR, color = Scenario)) +
  geom_line(size = 1) +
  geom_abline(linetype = "dashed", color = "gray") +
  labs(title = "ROC Curves for Chronic Student Absenteeism in California USA, K-12 Schools", 
       x = "False Positive Rate (1 - Specificity)", 
       y = "True Positive Rate (Sensitivity)") +
  scale_color_manual(values = c("Scenario 1" = "red", "Scenario 2" = "green", "Scenario 3" = "blue")) +
  theme_bw() + # Apply black and white theme
  annotate("text", x = 0.75, y = 0.25, 
           label = paste0("AUC S1: ", round(auc_val1, 2), 
                          "\nAUC S2: ", round(auc_val2, 2), 
                          "\nAUC S3: ", round(auc_val3, 2)), 
           color = "black", size = 4)

# Save the plot
ggsave("roc_curve_absenteeism_bw.png", plot = roc_plot, dpi = 300, width = 8, height = 6)

```

# Causal Inference 3D 

```{r}
# Install necessary packages if not already installed
# install.packages("rgl")
# install.packages("magick") # Needed for animation saving
# install.packages("ggplot2") # For data generation if desired

# Load the rgl library
library(rgl)

# --- 1. Simulate Data for Causal Inference Illustration ---
# We assume a causal effect: higher air quality and green space lead to lower absenteeism.
set.seed(123)
n_students <- 100
# Environmental factors (scaled from 0 to 10)
air_quality <- runif(n_students, 1, 10) # Higher is better
green_space <- runif(n_students, 1, 10) # Higher is better

# Absenteeism rate: negatively affected by air quality and green space, plus some noise
# Causal relationship: Absenteeism = Base Rate - (Effect of Air Quality) - (Effect of Green Space) + Noise
absenteeism_rate <- 20 - (air_quality * 1.0) - (green_space * 0.5) + rnorm(n_students, mean = 0, sd = 2)
# Ensure rates are non-negative
absenteeism_rate <- pmax(0, absenteeism_rate) 

data_sim <- data.frame(
  AirQuality = air_quality,
  GreenSpace = green_space,
  Absenteeism = absenteeism_rate
)

# --- 2. Create the 3D Visualization ---
# Open a new RGL device
open3d()

# Plot the data points (students). Points with low absenteeism can be green, high absenteeism red.
plot3d(
  x = data_sim$AirQuality,
  y = data_sim$GreenSpace,
  z = data_sim$Absenteeism,
  col = colorRampPalette(c("green", "yellow", "red"))(100)[cut(data_sim$Absenteeism, breaks = 100)],
  size = 5,
  type = 's', # 's' for spheres, representing students/schools
  xlab = "Improved Air Quality/Comfort (Retrofits)",
  ylab = "Surrounding Green Space (Trees)",
  zlab = "Chronic Absenteeism Rate (%)",
  main = "Causal Effect: Environmental Factors & Absenteeism"
)

# Add a regression plane to show the trend
# Fit a linear model to show the causal relationship (assuming model correctly identifies causal link)
model <- lm(Absenteeism ~ AirQuality + GreenSpace, data = data_sim)
surface3d(
  x = sort(unique(data_sim$AirQuality)),
  y = sort(unique(data_sim$GreenSpace)),
  z = predict(model, newdata = expand.grid(AirQuality = sort(unique(data_sim$AirQuality)), 
                                           GreenSpace = sort(unique(data_sim$GreenSpace)))),
  alpha = 0.4,
  col = "blue"
)

# Add a box around the plot for better viewing
box3d()

# Adjust the view
rgl.viewpoint(theta = 45, phi = 20, fov = 60)

# --- 3. Save a Spinning Animation Clip --- 
# The animation will loop based on duration and rpm and save a GIF file in your working directory

# Ensure the rgl package is loaded
library(rgl)
library(magick) # Required for converting frames to a GIF

# Bring the window to front (optional)
rgl.bringtotop() 

movie_file <- "Absenteeism_Causal_Effect_3D.gif"

# Define the spinning animation function
spin_animation <- spin3d(axis = c(0, 0, 1), rpm = 20) # Spin around the Z-axis at 20 rotations per minute

# Create the movie using movie3d()
# movie3d() takes the animation function as the first argument, followed by other parameters
movie3d(
  spin_animation,
  duration = 10, # 10 seconds duration
  fps = 20, # Changed from 15 to 20 (a factor of 100)
  movie = tools::file_path_sans_ext(movie_file), # Base name for the movie file (without extension)
  dir = getwd(), # Save in the current working directory
  type = "gif", # Specify GIF format
  clean = TRUE # Clean up temporary .png files after creation
)

message(paste("Animation saved to:", file.path(getwd(), movie_file)))

# --- 4. Save a static PNG image (optional, good for a static slide) ---
snapshot3d("Absenteeism_Causal_Effect_3D_Static.png")
message(paste("Static image saved to:", file.path(getwd(), "Absenteeism_Causal_Effect_3D_Static.png")))

```




# Create Maps of Case Study 
```{r}
# View Data on the World Map 
Treatment_Count_Data_All_coord <- read_csv("./data/Treatment_Count_Data_All_coord.csv", show_col_types = F)
# Load required packages
library(ggplot2)
library(mapdata)
library(mapview)
library(sf)
library(leaflet)
# get world map data
world_map <- map_data("world") %>% filter(long < -110 & long > -125, lat > 0 & lat < 50)
head(world_map,10)
# create map using ggplot2
ggplot() +
  geom_polygon(data = world_map, aes(x = long, y = lat, group = group), fill = "white", color = "grey") +
  geom_point(data = Treatment_Count_Data_All_coord, aes(x = LONGITUDE, y = LATITUDE, fill = Chronic_Absenteeism), size = 2, shape = 21) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(x = "Longitude", y = "Latitude", title = "Proposition 39 K-12 Schools in California, USA") + theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = paste0('./figures/', 'Prop39_Schools_Global_Map.png'), plot = last_plot(), width = 6, height = 4, units = "in", dpi = 300)
```

```{r}
#Map of Proposition 39 K-12 Schools in California,USA with OSM 
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
library(viridis)
library(ggplot2)
library(mapdata)
library(maps)
library(terra)
library(mapview)
library(sf)
library(leaflet)
library(webshot)
library(ggspatial)
library(ggmap)
library(maptiles)
library(tidyterra)
library(tidyverse)
library(OpenStreetMap)

# define the spatial extent to OpenStreetMap
lat1 <- 30; lat2 <- 43; lon1 <- -127; lon2 <- -112

# other 'type' options are "osm", "maptoolkit-topo", "bing", "stamen-toner",
# "stamen-watercolor", "esri", "esri-topo", "nps", "apple-iphoto", "skobbler";
# play around with 'zoom' to see what happens; 10 seems just right to me
ca_map <- openmap(c(lat2, lon1), c(lat1, lon2), zoom = NULL,                     
                  type = "esri-topo", mergeTiles = TRUE)

plot(ca_map)

# reproject onto WGS84
ca_map2 <- openproj(ca_map)

# use instead of 'ggplot()'
ca_map2_plt <- OpenStreetMap::autoplot.OpenStreetMap(ca_map2) + 
  annotate("text", label = "Pacific Ocean", 
           x = -123, y = 34, size = 5.0, angle = -60, colour = "navy") + 
 geom_point(data = Treatment_Count_Data_All_coord, aes(x = LONGITUDE, y = LATITUDE, fill = Chronic_Absenteeism), size = 2, shape = 21) +
  scale_fill_gradient(low = "white", high = "red") +
  labs(x = "Longitude", y = "Latitude", title = "Average Rate of Chronic Absenteeism in Proposition 39 K-12 Schools Across California, USA", fill = "(%)") + theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ca_map2_plt

ca_map2_plt + annotation_scale(location = "bl") +
annotation_north_arrow(location = "br", which_north = "true", style = north_arrow_nautical())
ggsave(filename = paste0('Prop39_Schools_ChronicAbsenteeism_Map.png'), plot = last_plot(), width = 10, height = 6, units = "in", dpi = 300)
```


# Interactive Map []
```{r}
# install.packages("webshot")
# webshot::install_phantomjs()
# library(sf)
# library(mapview)
# # create viewer (background layer 'OpenTopoMap')
# mapview(Treatment_Count_Data_All_coord)
# # make rendered html self-contained
# mapviewOptions(fgb = FALSE)
# Prop_39_schools_map <- mapview(Treatment_Count_Data_All_coord, 
#                                xcol = "LONGITUDE", 
#                                ycol = "LATITUDE", 
#                                crs = 4326,
#                                grid = FALSE)
# Prop_39_schools_map
# # save with OpenTopoMap background layer
# library(webshot)
# mapshot(Prop_39_schools_map, 
#         file = "Prop_39_schools_map.png")
```

# Graph conditions of K-12 schools

## Infrastructure 
```{r}
library(dplyr)
library(readr)
Schools_Year_Built <- read_csv("./data/Schools_Year_Built_Analysis_Data.csv", show_col_types = F)
# Load the required libraries
library(ggplot2)
# Create the density plot with kernel selection
ggplot(Schools_Year_Built, aes(x = Year_built, y = ..density..)) +
  geom_density(aes(fill = "Density"), alpha = 0.5,
               kernel = "rectangular") +
  scale_fill_manual(values = "lightgreen",
                    guide = guide_legend(override.aes = list(color = NA))) +
  labs(title = "Year Built of K-12 Schools in California, USA",
       x = "Year Built",
       y = "Density") + 
  theme_bw() + theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
ggsave(filename = paste0('./figures/', 'Year_Built_Schools.png'), plot = last_plot(), width = 6.5, height = 4, units = "in", dpi = 300)
```

## Environment
```{r}
#Graph the Relationship of NDVI and LST
library(dplyr)
library(readr)
library(ggplot2)
Schools_Environment_Data <- read_csv("./data/Schools_Environment_Data.csv")
# Load the required libraries
# install.packages("ggbeeswarm")
library(ggbeeswarm)
library(ggplot2)
library(viridis)
p <- ggplot(Schools_Environment_Data, aes(x = NDVI_Under_Over_Avg, y = NDVI_median, color = Land_Surface_Temp)) +
  geom_quasirandom() + 
  labs(title = "NDVI and LST near K-12 Schools in California, USA",
       x = "Environmental Health",
       y = "Median Normalized Difference Vegetation Index") + 
      labs(color = "(Â°C)") +
  theme_bw() + theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title
p + scale_color_gradient(low = "blue", high = "yellow")
ggsave(filename = './figures/NDVI_LST_Schools.png', plot = last_plot(), width = 6.5, height = 4, units = "in", dpi = 300)
```

```{r}
#Graph the Relationship of LULC and LST 
library(ggplot2)
ggplot() + 
  geom_point(data=Treatment_Count_Data_All_coord, aes(x=Percent_Water, y=Land_Surface_Temp, color="Water",alpha = 0.5), size=2) + 
  geom_point(data=Treatment_Count_Data_All_coord, aes(x=Percent_Pasture, y=Land_Surface_Temp, color="Pasture", alpha = 0.5), size=2) + 
  geom_point(data=Treatment_Count_Data_All_coord, aes(x=Percent_Forest, y=Land_Surface_Temp, color="Forest", alpha = 0.5), size=2) +
  geom_point(data=Treatment_Count_Data_All_coord, aes(x=Percent_Developed, y=Land_Surface_Temp, color="Developed, alpha = 0.5"), size=2) +
  xlim(0, 100) + 
  xlab("Land Use and Land Cover (%)") +
   ylab("Land Surface Temperature (Â°C)") +
    labs(color = "Type of LULC") +
   ggtitle("Relationship of LULC, NDVI, and LST near K-12 Schools in Calfornia, USA") + 
  theme_bw() + theme(plot.title = element_text(hjust = 0.5))
ggsave(filename = './figures/LULC_NDVI_LST.png', plot = last_plot(), width = 6.5, height = 4, units = "in", dpi = 300)
```


#Causal Inference Diagram 

```{r}

diagram_code <- "
digraph causal_pathway {

  # Graph and Node settings
  graph [layout = dot, rankdir = LR];
  node [shape = box, style = rounded, fontname = Helvetica];
  edge [color = gray, arrowhead = normal];

  # Node definitions
  EE_Retrofits [label = 'Energy Efficiency Retrofits\n(Lighting, HVAC, Pumps, Envelope)'];
  Reduced_Costs [label = 'Reduced Energy Costs'];
  Poorer_Ventilation [label = 'Poorer Natural Ventilation\n(from building envelope upgrades)'];
  Concentrated_Pollutants [label = 'Concentrated Indoor Pollutants\n(e.g., Mold, Particulates)'];
  Adverse_Health_Effects [label = 'Adverse Health Effects\n(e.g., Respiratory Issues)'];
  SES_Status [label = 'Socioeconomic Status (SES)\n(of student population)'];
  Chronic_Absenteeism [label = 'Chronic Student Absenteeism'];

  # Arrows representing causal links
  EE_Retrofits -> Poorer_Ventilation;
  EE_Retrofits -> Reduced_Costs;
  Poorer_Ventilation -> Concentrated_Pollutants;
  Concentrated_Pollutants -> Adverse_Health_Effects;
  Adverse_Health_Effects -> Chronic_Absenteeism;

  # Path related to SES status
  SES_Status -> EE_Retrofits [style = dashed, label = 'Often occurs in low-SES schools'];
  SES_Status -> Adverse_Health_Effects [style = dashed, label = 'Limited access to healthcare'];
  SES_Status -> Chronic_Absenteeism [style = dashed, label = 'Other barriers'];

  # Styling nodes for clarity
  EE_Retrofits [fillcolor = '#D1E8E2', style = 'rounded, filled'];
  Chronic_Absenteeism [fillcolor = '#EA9F9B', style = 'rounded, filled'];
  SES_Status [shape = diamond, style = 'filled', fillcolor = '#F9E5C5'];

  # Add a dashed border around the main causal path
  subgraph cluster_main_path {
    style = dashed;
    label = 'Primary Causal Path';
    Poorer_Ventilation;
    Concentrated_Pollutants;
    Adverse_Health_Effects;
    Chronic_Absenteeism;
  }
}
"

# Create the graph object
graph <- grViz(diagram_code)

# Save the diagram as a PNG file with specified DPI
# First, need to render the graph to a temporary SVG, then convert to PNG
# The 'rsvg' package is necessary for this conversion

install.packages("rsvg")
install.packages("DiagrammeR")
install.packages("DiagrammeRsvg")

library(rsvg)
library(DiagrammeR)
library(DiagrammeRsvg)

# Save as temporary SVG
tmp_svg <- tempfile(fileext = ".svg")
export_svg <- function(graph, file) {
  grViz(diagram_code) %>%
    DiagrammeRsvg::export_svg() %>%
    write(file)
}

# Use DiagrammeR s internal function to export SVG
DiagrammeRsvg::export_svg(graph) %>% 
  charToRaw() %>% 
  # This will produce a 3000-pixel wide image.
  rsvg_png("causal_diagram_retrofit_absenteeism.png", height = 1200, width = 3000)
```

# View Session Information
```{r}
#To print the version information about R, the Operating System, and attached or loaded packages, use the sessionInfo() function. 
sessionInfo()
```
