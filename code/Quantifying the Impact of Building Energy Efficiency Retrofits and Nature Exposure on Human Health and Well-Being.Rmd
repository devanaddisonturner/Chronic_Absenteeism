---
title: "Quantifying the Impact of Building Energy Efficiency Retrofits and Nature Exposure on Human Health and Well-Being"
author: "Devan Cantrell Addison-Turner, Yingjie Li, Anthony Dylan Kinslow II, Gretchen Cara Daily, and Rishee Kumar Jain"
date: "2024-06-27"
output: html_document
---


# Setup
```{r}
#Get working directory and file path information, then set for working environment in the current R session.
getwd()
# setwd('path')
```

```{r include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


## Packages --------------------------------------------------------------------
# install.packages("readr", dependencies = TRUE)
# install.packages("readxl", dependencies = TRUE)

### --- viz ----
# install.packages("ggplot2")
library(ggplot2)
#install.packages("viridis")
# install.packages("tidyverse", dependencies = TRUE)
# install.packages("dplyr", dependencies = TRUE)

library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
library(viridis)

### --- to impute data ----
# install.packages("devtools")
# install.packages("lattice")
# install.packages("VIM")
library(lattice)
library(VIM) ## aggr()


#Run the following lines twice to complete install of the mice package. This archived version of the MICE package is not compatible with Mac0S. Instead, use Windows operating system.
library(devtools)
#install_version("mice", version = "3.11.0", repos = "https://cloud.r-project.org")
library(mice)

### ---- Matching ----
#install.packages("MatchIt")
#install.packages("optmatch")
##Note: MatchIt package may not install or load on MacOS. Instead, use Windows OS.

library(MatchIt)
```

# Data

## Input data

### Raw data 

 Examine if inequalities exist in K-12 Schools across California, USA from 2020-2022 in context of the COVID-19 Pandemic
 
```{r}
library(ggplot2)
library(viridis)
library(readr)
library(readxl)

CASchools_Data_income_subset <- read_csv("./data/CASchools_Data_income_subset.csv")

CASchools_Data_income_subset$income_f = factor(CASchools_Data_income_subset$income, levels=c('high income','medium income','low income'))

ggplot(CASchools_Data_income_subset, aes(x = Pollution_Burden, y = Chronic_Absenteeism, color =  Diversity_Index, alpha = 0.5)) + 
#geom specifies the type of graph points to be displayed
  geom_point() + scale_color_viridis() + theme_bw() +
  facet_grid(School_Type ~ income_f) + xlim(0, 100) + ylim(0, 100) + 
labs(x = "Pollution Burden, %", 
       y = "Chronic Absenteeism Rate, %", 
       title ="Pollution Burden and Chronic Absenteeism in California, USA K-12 Schools") + 
  theme(plot.title = element_text(hjust = 0.5))  # Center ggplot title

ggsave(filename = './figures/', 'Pollution_ChronicAbsenteeism_SEProfile.png', plot = last_plot(), width = 9, height = 6, units = "in", dpi = 300)
```


 California, USA K-12 Schools Raw Dataset to simulate 3 interventions effects on Chronic Absenteeism during the COVID-19 Pandemic

```{r  Overall Data}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)

#CASchools_PSM_Data <- read_csv("./data/ChronicAbsenteeism_Schools_PSM_Data.csv")

#changing variable to numeric for the Overall Dataset
CASchools_PSM_Data2 <- CASchools_PSM_Data %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -Percent_LandCoverTotal,
                -Diversity_Index,
                -Average_NDVI_median,
                -Student_Staff_Ratio,
                -StudentEnrollment_mean,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```

```{r   Subset Data}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse)
CASchools_PSM_Datacomplete <- read_csv("CA_Schools_PSM_Datacomplete_2.csv")

#changing variable to numeric for the Overall Dataset
CASchools_PSM_Datacomplete2 <- CASchools_PSM_Datacomplete %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water),
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff),
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                -CDS_Code,
                -char_prem_id,
                -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```

#### Subset Data by 4 types of Energy Efficiency Retrofits
```{r}
CASchools_PSM_Data_subL <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Lighting")
CASchools_PSM_Data_subH <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "HVAC")
CASchools_PSM_Data_subB <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Building_Envelope")
CASchools_PSM_Data_subP <- subset(CASchools_PSM_Datacomplete, EE_Retrofit_Type == "Pumps_Motors_Drives")
```

```{r}
# 1. EE Retrofit - Lighting 
#changing variable to numeric with subset data
CASchools_PSM_Data_subL2 <- CASchools_PSM_Data_subL %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                -CDS_Code,
                -char_prem_id,
                -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#2. EE Retrofit - HVAC
#changing variable to numeric with subset data
CASchools_PSM_Data_subH2 <- CASchools_PSM_Data_subH %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                -CDS_Code,
                -char_prem_id,
                -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#3. EE Retrofit - Building Envelope 

#changing variable to numeric with subset data
CASchools_PSM_Data_subB2 <- CASchools_PSM_Data_subB %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                -CDS_Code,
                -char_prem_id,
                -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')


#4. EE Retrofit - Pumps, Motors, & Drives

#changing variable to numeric with subset data
CASchools_PSM_Data_subP2 <- CASchools_PSM_Data_subP %>%
  dplyr::mutate(
    Percent_Water = as.numeric(Percent_Water), 
    Percent_Developed = as.numeric(Percent_Developed),
    Percent_Forest = as.numeric(Percent_Forest),
    Percent_Pasture = as.numeric(Percent_Pasture),
    Staff = as.numeric(Staff), 
    NDVI_median = as.numeric(NDVI_median),
    Land_Surface_Temp = as.numeric(Land_Surface_Temp),
    Year_built = as.numeric(Year_built),
    Median_income_BG = as.numeric(Median_income_BG),
    Percent_FRPM = as.numeric(Percent_FRPM),
    Students_with_Disabilities = as.numeric(Students_with_Disabilities),
    Asthma_Rates = as.numeric(Asthma_Rates),
    COVID_infections = as.numeric(COVID_infections),
    Pollution_Burden = as.numeric(Pollution_Burden),
    Chronic_Absenteeism = as.numeric(Chronic_Absenteeism),
    retrofit = as.numeric(retrofit),
    ndvi_median_binary = as.numeric(ndvi_median_binary),
    retrofit_and_ndvi = as.numeric(retrofit_and_ndvi),
    )  %>%
    dplyr::select(
      #removed variables we do not need
                -EEM,
                -EE_Retrofit_Type,
                -CDS_Code,
                -char_prem_id,
                -Order,
              ) %>%
  as.data.frame() %>%
#We moved the school ID as column as row name to keep all the data in numeric
  column_to_rownames(var = 'School_ID')
```


### Impute data and plot

  All multiple imputation techniques start with the MAR assumption (Missing at Random). 

  https://library.virginia.edu/data/articles/getting-started-with-multiple-imputation-in-r

```{r}
library(lattice)
library(VIM)
library(mice)
# Visualize Proportion of missing data
f <- paste0('./figures/', 'data_missing.png'); print(f)
png(filename = f, width = 7, height = 5, units = "in", res = 300)
cex.axis.size = 0.425
aggr(CASchools_PSM_Data2, cex.axis=cex.axis.size)
dev.off()

#Number of rows that would not be removed due to missing data
nrow(na.omit(CASchools_PSM_Data2))

# Multivariate Imputation by Chained-Equations (MICE)
#fill missing values in dataset by prediction through multiple iterations using
#the MICE algorithm
set.seed(27)
CASchools_PSM_Dataimp <- mice(CASchools_PSM_Data2, seed = 27)

# Complete dataset after imputation and store as a new dataframe
CASchools_PSM_Datacomplete_og <- complete(CASchools_PSM_Dataimp)


#Visualize Proportion of missing data in Imputed Dataset
f <- paste0('./figures/', 'data_missing_Imputed.png'); print(f)
png(filename = f, width = 7, height = 5, units = "in", res = 300)
aggr(CASchools_PSM_Datacomplete_og, cex.axis=cex.axis.size)
dev.off()

#Number of rows that would not be removed due to missing data
nrow(na.omit(CASchools_PSM_Datacomplete_og))

```

### Data Normalization
```{r  Overall Data}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

maxmin_scalar <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin <- as.data.frame(lapply(CASchools_PSM_Data2, maxmin_scalar))

scaling_maxmin$School_ID <- rownames(CASchools_PSM_Data2)

scaling_maxmin_dropna <- scaling_maxmin %>%
  tidyr::drop_na()

######### Imputed Dataset

maxmin_scalar_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_complete <- as.data.frame(lapply(CASchools_PSM_Datacomplete_og, maxmin_scalar_complete))

scaling_maxmin_complete$School_ID <- rownames(CASchools_PSM_Datacomplete_og)
```

```{r  EE Retrofit --- 1. Lighting}

######### Imputed Dataset

maxmin_scalar_L_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_L_complete <- as.data.frame(lapply(CASchools_PSM_Data_subL2, maxmin_scalar_L_complete))

scaling_maxmin_L_complete$School_ID <- rownames(CASchools_PSM_Data_subL2)
```

```{r EE Retrofit -- 2. HVAC}

######### Imputed Dataset

maxmin_scalar_H_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_H_complete <- as.data.frame(lapply(CASchools_PSM_Data_subH2, maxmin_scalar_H_complete))

scaling_maxmin_H_complete$School_ID <- rownames(CASchools_PSM_Data_subH2)
```

```{r  EE Retrofit -- 3. Building Envelope}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_B_complete <- function(x){
  (x- min(x, na.rm = T)) / (max(x, na.rm = T) - min(x, na.rm = T))
  }
scaling_maxmin_B_complete <- as.data.frame(lapply(CASchools_PSM_Data_subB2, maxmin_scalar_B_complete))

scaling_maxmin_B_complete$School_ID <- rownames(CASchools_PSM_Data_subB2)  

scaling_maxmin_B_complete$Percent_Forest[scaling_maxmin_B_complete$Percent_Forest] <- 0

scaling_maxmin_B_complete$Percent_Forest[which(scaling_maxmin_B_complete$Percent_Forest == "NaN")] = 0.0000000
```

```{r EE Retrofit -- 4. Pumps, Motors, and Drives}

#Create a function to normalize variables on a scale from 0 to 1 then apply to dataset

######### Imputed Dataset

maxmin_scalar_P_complete <- function(x) {
  if(min(x, na.rm=TRUE)!=max(x, na.rm=TRUE)) {
    res <- ((x - min(x, na.rm=TRUE)) / (max(x, na.rm=TRUE) - min(x, na.rm=TRUE)))
  } else {
    res <- 0.5
  }
  res
}
scaling_maxmin_P_complete <- as.data.frame(lapply(CASchools_PSM_Data_subP2, maxmin_scalar_P_complete))
scaling_maxmin_P_complete$School_ID <- rownames(CASchools_PSM_Data_subP2)  
```

# Pair-Matching Algorithm - 3 Scenarios

## Using non-imputed data

### Scenario 1: Energy Efficiency (EE) Retrofits in K-12 Schools

```{r}
library(MatchIt)
#
#1:1 optimal PS matching with optimal matching on School covariates
m.out1 <- matchit(retrofit ~ 
                    NDVI_median +	
                    Percent_Water	+ Percent_Developed + Percent_Forest +	
                    Percent_Pasture + Land_Surface_Temp + Year_built +
                    Median_income_BG +	Percent_FRPM + Staff +
                    Students_with_Disabilities +	Asthma_Rates +	
                    COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_dropna,
                  method = "optimal") 
summary(m.out1)


### Scenario 1: Energy Efficiency Retrofits in K-12 Schools
m.out1
summary(m.out1, un = FALSE)

m_data <- match.data(m.out1)
mm <- na.omit(m.out1$match.matrix)
m_data <- m_data[rownames(m_data) %in% rownames(mm) |
                   rownames(m_data) %in% mm,]
#print(m_data)
```



### Scenario 2: Nature Exposure in K-12 Schools
```{r}
m.out2 <- matchit(ndvi_median_binary ~ 
                    retrofit +	
                    Percent_Water	+ Percent_Developed + Percent_Forest +	
                    Percent_Pasture + Land_Surface_Temp + Year_built +
                    Median_income_BG +	Percent_FRPM + Staff +	
                    Students_with_Disabilities +	Asthma_Rates +	
                    COVID_infections +	Pollution_Burden,
                   data = scaling_maxmin_dropna,
                   method = "optimal")
summary(m.out2)

### Scenario 2: Nature Exposure in K-12 Schools
m.out2
summary(m.out2, un = FALSE)
m_data2 <- match.data(m.out2)
mm2 <- na.omit(m.out2$match.matrix)
m_data2 <- m_data2[rownames(m_data2) %in% rownames(mm2) |
                   rownames(m_data2) %in% mm2,]
```



### Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools 
```{r}
m.out3 <- matchit(retrofit_and_ndvi ~ 
                    Percent_Water	+ Percent_Developed + Percent_Forest +	
                    Percent_Pasture + Land_Surface_Temp	+ Year_built +
                    Median_income_BG +	Percent_FRPM + Staff +
                    Students_with_Disabilities +	Asthma_Rates +	
                    COVID_infections +	Pollution_Burden,
                   data = scaling_maxmin_dropna,
                   method = "optimal")
summary(m.out3)

### Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools 
m.out3
summary(m.out3, un = FALSE)
m_data3 <- match.data(m.out3)
mm3 <- na.omit(m.out3$match.matrix)
m_data3 <- m_data3[rownames(m_data3) %in% rownames(mm3) |
                   rownames(m_data3) %in% mm3,]
```


## Using Imputed Data

### Scenario 1: Energy Efficiency Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_complete,
                  method = "optimal") 
summary(m.out1_complete)
 
m.out1_complete
summary(m.out1_complete, un = FALSE)
m_data_complete <- match.data(m.out1_complete)
```


#### Scenario 1L: Lighting Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1L_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_L_complete,
                  method = "optimal") 
summary(m.out1L_complete)
 
m.out1L_complete
summary(m.out1L_complete, un = FALSE)
m_data_L_complete <- match.data(m.out1L_complete)
```


#### Scenario 1H: HVAC Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1H_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_H_complete,
                  method = "optimal") 
summary(m.out1H_complete)
 
m.out1H_complete
summary(m.out1H_complete, un = FALSE)
m_data_H_complete <- match.data(m.out1H_complete)

```


#### Scenario 1B: Building Envelope Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1B_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_B_complete,
                  method = "optimal") 
summary(m.out1B_complete)
 
m.out1B_complete
summary(m.out1B_complete, un = FALSE)
m_data_B_complete <- match.data(m.out1B_complete)

```


#### Scenario 1P: Pumps, Motors, and Drives Retrofits in K-12 Schools with Imputed Dataset

```{r}
#1:1 optimal PS matching with optimal matching on School covariates
m.out1P_complete <- matchit(retrofit ~ NDVI_median +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_P_complete,
                  method = "optimal") 
summary(m.out1P_complete)
 
m.out1P_complete
summary(m.out1P_complete, un = FALSE)
m_data_P_complete <- match.data(m.out1P_complete)

```


### Scenario 2: Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out2_complete <- matchit(ndvi_median_binary ~ retrofit +	Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +	
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                   data = scaling_maxmin_complete,
                   method = "optimal")
summary(m.out2_complete)
m.out2_complete
summary(m.out2_complete, un = FALSE)
m_data2_complete <- match.data(m.out2_complete)
```


### Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_complete,
                  method = "optimal")
summary(m.out3_complete)

m.out3_complete
summary(m.out3_complete, un = FALSE)
m_data3_complete <- match.data(m.out3_complete)
```


#### Scenario 3L: Lighting Retrofits and Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_L <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_L_complete,
                  method = "optimal")
summary(m.out3_complete_L)

m.out3_complete_L
summary(m.out3_complete_L, un = FALSE)
m_data3_complete_L <- match.data(m.out3_complete_L)
```

#### Scenario 3H: HVAC Retrofits and Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_H <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_H_complete,
                  method = "optimal")
summary(m.out3_complete_H)

m.out3_complete_H
summary(m.out3_complete_H, un = FALSE)
m_data3_complete_H <- match.data(m.out3_complete_H)
```

#### Scenario 3B: Building Envelope Retrofits and Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_B <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_B_complete,
                  method = "optimal")
summary(m.out3_complete_B)

m.out3_complete_B
summary(m.out3_complete_B, un = FALSE)
m_data3_complete_B <- match.data(m.out3_complete_B)
```


#### Scenario 3P: Pumps, Motors, & Drives Retrofits and Nature Exposure in K-12 Schools with Imputed Dataset

```{r}
m.out3_complete_P <- matchit(retrofit_and_ndvi ~ Percent_Water	+
                           Percent_Developed + Percent_Forest +	
                           Percent_Pasture + Land_Surface_Temp + Year_built +
                           Median_income_BG +	Percent_FRPM + Staff +
                           Students_with_Disabilities +	Asthma_Rates +	
                           COVID_infections +	Pollution_Burden,
                  data = scaling_maxmin_P_complete,
                  method = "optimal")
summary(m.out3_complete_P)

m.out3_complete
summary(m.out3_complete_P, un = FALSE)
m_data3_complete_P <- match.data(m.out3_complete_P)
```



## Control and Treatment subsets

### Raw Data
```{r Scenario 1}
### Scenario 1: Energy Efficiency Retrofits in K-12 Schools

#Control Group 
m_data_c <- m_data %>%
  dplyr::filter(retrofit == 0 )

#Treatment Group
m_data_t <- m_data %>%
  dplyr::filter(retrofit == 1)


## left join raw outcome data
raw <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data_c_withRaw <- m_data_c %>%
  left_join(., raw, by = 'School_ID')


m_data_t_withRaw <- m_data_t %>%
  left_join(., raw, by = 'School_ID')

m_data_wide <- merge(
  x = m_data_c, 
  y = m_data_t,
  by = 'subclass'
)

m_data_wide_2 <- merge(
  x = m_data_c_withRaw, 
  y = m_data_t_withRaw,
  by = 'subclass'
)
```




```{r Scenario 2}
## Scenario 2: Nature Exposure in K-12 Schools

#Control Group 
m_data2_c <- m_data2 %>%
  dplyr::filter(ndvi_median_binary == 0 )

#Treatment Group
m_data2_t <- m_data2 %>%
  dplyr::filter(ndvi_median_binary == 1)


## left join raw outcome data
raw_2 <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data2_c_withRaw <- m_data2_c %>%
  left_join(., raw_2, by = 'School_ID')


m_data2_t_withRaw <- m_data2_t %>%
  left_join(., raw_2, by = 'School_ID')

m_data_wide_3 <- merge(
  x = m_data2_c, 
  y = m_data2_t,
  by = 'subclass'
)

m_data_wide_4 <- merge(
  x = m_data2_c_withRaw, 
  y = m_data2_t_withRaw,
  by = 'subclass'
)
```



```{r Scenario 3}
## Scenario 3: Energy Efficiency and Nature Exposure in K-12 Schools

#Control Group 
m_data3_c <- m_data3 %>%
  dplyr::filter(retrofit_and_ndvi == 0 )

#Treatment Group
m_data3_t <- m_data3 %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3 <- CASchools_PSM_Data2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw <- m_data3_c %>%
  left_join(., raw_3, by = 'School_ID')


m_data3_t_withRaw <- m_data3_t %>%
  left_join(., raw_3, by = 'School_ID')

m_data_wide_5 <- merge(
  x = m_data3_c, 
  y = m_data3_t,
  by = 'subclass'
)

m_data_wide_6 <- merge(
  x = m_data3_c_withRaw, 
  y = m_data3_t_withRaw,
  by = 'subclass'
)
```

### Imputed Data Scenario 1

```{r Scenario 1}
### Scenario 1: Energy Efficiency Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete <- m_data_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete <- m_data_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete <- CASchools_PSM_Datacomplete_og %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete <- m_data_c_complete %>%
  left_join(., raw_complete, by = 'School_ID')

m_data_t_withRaw_complete <- m_data_t_complete %>%
  left_join(., raw_complete, by = 'School_ID')

m_data_wide_complete <- merge(
  x = m_data_c_complete, 
  y = m_data_t_complete,
  by = 'subclass'
)

m_data_wide_2_complete <- merge(
  x = m_data_c_withRaw_complete, 
  y = m_data_t_withRaw_complete,
  by = 'subclass'
)
```



#### Imputed Data 1L

```{r Scenario 1L}
### Scenario 1: Lighting Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_L <- m_data_L_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_L <- m_data_L_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_L <- CASchools_PSM_Data_subL2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_L <- m_data_c_complete_L %>%
  left_join(., raw_complete_L, by = 'School_ID')

m_data_t_withRaw_complete_L <- m_data_t_complete_L %>%
  left_join(., raw_complete_L, by = 'School_ID')

m_data_wide_complete_L <- merge(
  x = m_data_c_complete_L, 
  y = m_data_t_complete_L,
  by = 'subclass'
)

m_data_wide_2_complete_L <- merge(
  x = m_data_c_withRaw_complete_L, 
  y = m_data_t_withRaw_complete_L,
  by = 'subclass'
)
```



#### Imputed Data 1H

```{r Scenario 1H}
### Scenario 1: HVAC Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_H <- m_data_H_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_H <- m_data_H_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_H <- CASchools_PSM_Data_subH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_H <- m_data_c_complete_H %>%
  left_join(., raw_complete_H, by = 'School_ID')

m_data_t_withRaw_complete_H <- m_data_t_complete_H %>%
  left_join(., raw_complete_H, by = 'School_ID')

m_data_wide_complete_H <- merge(
  x = m_data_c_complete_H, 
  y = m_data_t_complete_H,
  by = 'subclass'
)

m_data_wide_2_complete_H <- merge(
  x = m_data_c_withRaw_complete_H, 
  y = m_data_t_withRaw_complete_H,
  by = 'subclass'
)
```

#### Imputed Data 1B

```{r Scenario 1B}
### Scenario 1: Building Envelope Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_B <- m_data_B_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_B <- m_data_B_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_B <- CASchools_PSM_Data_subB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_B <- m_data_c_complete_B %>%
  left_join(., raw_complete_B, by = 'School_ID')

m_data_t_withRaw_complete_B <- m_data_t_complete_B %>%
  left_join(., raw_complete_B, by = 'School_ID')

m_data_wide_complete_B <- merge(
  x = m_data_c_complete_B, 
  y = m_data_t_complete_B,
  by = 'subclass'
)

m_data_wide_2_complete_B <- merge(
  x = m_data_c_withRaw_complete_B, 
  y = m_data_t_withRaw_complete_B,
  by = 'subclass'
)
```

#### Imputed Data 1P

```{r Scenario 1P}
### Scenario 1: Pumps, Motors, & Drives Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data_c_complete_P <- m_data_P_complete %>%
  dplyr::filter(retrofit == 0)

#Treatment Group
m_data_t_complete_P <- m_data_P_complete %>%
  dplyr::filter(retrofit == 1)

## left join raw outcome data
raw_complete_P <- CASchools_PSM_Data_subP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')

m_data_c_withRaw_complete_P <- m_data_c_complete_P %>%
  left_join(., raw_complete_P, by = 'School_ID')

m_data_t_withRaw_complete_P <- m_data_t_complete_P %>%
  left_join(., raw_complete_P, by = 'School_ID')

m_data_wide_complete_P <- merge(
  x = m_data_c_complete_P, 
  y = m_data_t_complete_P,
  by = 'subclass'
)

m_data_wide_2_complete_P <- merge(
  x = m_data_c_withRaw_complete_P, 
  y = m_data_t_withRaw_complete_P,
  by = 'subclass'
)
```


### Scenario 2

```{r Scenario 2}
### Scenario 2: Nature Exposure in K-12 Schools with Imputed Data

#Control Group 
m_data2_c_complete <- m_data2_complete %>%
  dplyr::filter(ndvi_median_binary == 0 )

#Treatment Group
m_data2_t_complete <- m_data2_complete %>%
  dplyr::filter(ndvi_median_binary == 1)

## left join raw outcome data
raw_2_complete <- CASchools_PSM_Datacomplete_og %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data2_c_withRaw_complete <- m_data2_c_complete %>%
  left_join(., raw_2_complete, by = 'School_ID')

m_data2_t_withRaw_complete <- m_data2_t_complete %>%
  left_join(., raw_2_complete, by = 'School_ID')

m_data_wide_3_complete <- merge(
  x = m_data2_c_complete, 
  y = m_data2_t_complete,
  by = 'subclass'
)

m_data_wide_4_complete <- merge(
  x = m_data2_c_withRaw_complete, 
  y = m_data2_t_withRaw_complete,
  by = 'subclass'
)
```


### Scenario 3

```{r Scenario 3}
### Scenario 3: Energy Efficiency and Nature Exposure in K-12 Schools with Imputed Data

#Control Group 
m_data3_c_complete <- m_data3_complete %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete <- m_data3_complete %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete <- CASchools_PSM_Datacomplete2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete <- m_data3_c_complete %>%
  left_join(., raw_3_complete, by = 'School_ID')


m_data3_t_withRaw_complete <- m_data3_t_complete %>%
  left_join(., raw_3_complete, by = 'School_ID')

m_data_wide_5_complete <- merge(
  x = m_data3_c_complete, 
  y = m_data3_t_complete,
  by = 'subclass'
)

m_data_wide_6_complete <- merge(
  x = m_data3_c_withRaw_complete, 
  y = m_data3_t_withRaw_complete,
  by = 'subclass'
)
```

#### Imputed Data 3L

```{r Scenario 3L}
### Scenario 3L: Lighting Retrofits in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_L <- m_data3_complete_L %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_L <- m_data3_complete_L %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_L <- CASchools_PSM_Data_subL2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_L <- m_data3_c_complete_L %>%
  left_join(., raw_3_complete_L, by = 'School_ID')


m_data3_t_withRaw_complete_L <- m_data3_t_complete_L %>%
  left_join(., raw_3_complete_L, by = 'School_ID')

m_data_wide_5_complete_L <- merge(
  x = m_data3_c_complete_L, 
  y = m_data3_t_complete_L,
  by = 'subclass'
)

m_data_wide_6_complete_L <- merge(
  x = m_data3_c_withRaw_complete_L, 
  y = m_data3_t_withRaw_complete_L,
  by = 'subclass'
)
```



#### Imputed Data 3H

```{r Scenario 3H}
### Scenario 3H: HVAC Retrofits and Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_H <- m_data3_complete_H %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_H <- m_data3_complete_H %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_H <- CASchools_PSM_Data_subH2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_H <- m_data3_c_complete_H %>%
  left_join(., raw_3_complete_H, by = 'School_ID')


m_data3_t_withRaw_complete_H <- m_data3_t_complete_H %>%
  left_join(., raw_3_complete_H, by = 'School_ID')

m_data_wide_5_complete_H <- merge(
  x = m_data3_c_complete_H, 
  y = m_data3_t_complete_H,
  by = 'subclass'
)

m_data_wide_6_complete_H <- merge(
  x = m_data3_c_withRaw_complete_H, 
  y = m_data3_t_withRaw_complete_H,
  by = 'subclass'
)
```

#### Imputed Data 3B

```{r Scenario 3B}
### Scenario 3B: Building Envelope Retrofits and Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_B <- m_data3_complete_B %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_B <- m_data3_complete_B %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_B <- CASchools_PSM_Data_subB2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_B <- m_data3_c_complete_B %>%
  left_join(., raw_3_complete_B, by = 'School_ID')


m_data3_t_withRaw_complete_B <- m_data3_t_complete_B %>%
  left_join(., raw_3_complete_B, by = 'School_ID')

m_data_wide_5_complete_B <- merge(
  x = m_data3_c_complete_B, 
  y = m_data3_t_complete_B,
  by = 'subclass'
)

m_data_wide_6_complete_B <- merge(
  x = m_data3_c_withRaw_complete_B, 
  y = m_data3_t_withRaw_complete_B,
  by = 'subclass'
)
```

#### Imputed Data 3P

```{r Scenario 3P}
### Scenario 3P: Pumps, Motors, & Drives Retrofits and Nature Exposure in K-12 Schools with Imputed Data
#Control Group 
m_data3_c_complete_P <- m_data3_complete_P %>%
  dplyr::filter(retrofit_and_ndvi == 0)

#Treatment Group
m_data3_t_complete_P <- m_data3_complete_P %>%
  dplyr::filter(retrofit_and_ndvi == 1)


## left join raw outcome data
raw_3_complete_P <- CASchools_PSM_Data_subP2 %>%
  dplyr::select(Chronic_Absenteeism) %>%
  dplyr::mutate(School_ID = rownames(.)) %>%
  dplyr::rename('Chronic_Absenteeism_raw' = 'Chronic_Absenteeism')


m_data3_c_withRaw_complete_P <- m_data3_c_complete_P %>%
  left_join(., raw_3_complete_P, by = 'School_ID')


m_data3_t_withRaw_complete_P <- m_data3_t_complete_P %>%
  left_join(., raw_3_complete_P, by = 'School_ID')

m_data_wide_5_complete_P <- merge(
  x = m_data3_c_complete_P, 
  y = m_data3_t_complete_P,
  by = 'subclass'
)

m_data_wide_6_complete_P <- merge(
  x = m_data3_c_withRaw_complete_P, 
  y = m_data3_t_withRaw_complete_P,
  by = 'subclass'
)
```

# Statistical Analysis 

## Compute T-Test

### Using Raw data
```{r}
## Scenario 1: Energy Efficiency Retrofits in K-12 Schools 
TTestS1 <- t.test(m_data_wide_2$Chronic_Absenteeism_raw.x, m_data_wide_2$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1)

## Scenario 2: Nature Exposure in Schools
TTestS2 <- t.test(m_data_wide_4$Chronic_Absenteeism_raw.x, m_data_wide_4$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS2)

## Scenario 3: Energy Efficiency Retrofits in K-12 Schools and Nature Exposure in K-12 Schools
TTestS3 <- t.test(m_data_wide_6$Chronic_Absenteeism_raw.x,m_data_wide_6$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3)
```


### Using Imputed Data

```{r}
## Scenario 1: Energy Efficiency in K-12 Schools with Imputed Data
TTestS1_complete <- t.test(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete)

## Scenario 1L: Lighting Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_L <- t.test(m_data_wide_2_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_L)


## Scenario 1H: HVAC Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_H <- t.test(m_data_wide_2_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_H)


## Scenario 1B: Building Envelope Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_B <- t.test(m_data_wide_2_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_B)

## Scenario 1P: Pumps, Motors, and Drives Retrofits in K-12 Schools with Imputed Data
TTestS1_complete_P <- t.test(m_data_wide_2_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS1_complete_P)

## Scenario 2: Nature Exposure in K-12 Schools with Imputed Data
TTestS2_complete <- t.test(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS2_complete)

## Scenario 3: Energy Efficiency and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete <- t.test(m_data_wide_6_complete$Chronic_Absenteeism_raw.x, m_data_wide_6_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete)

## Scenario 3L: Lighting Retrofits and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_L <- t.test(m_data_wide_6_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_L)

## Scenario 3H: HVAC Retrofits and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_H <- t.test(m_data_wide_6_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_H)


## Scenario 3B: Building Envelope Retrofits and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_B <- t.test(m_data_wide_6_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_B)

## Scenario 3P: Pumps, Motors, & Drives Retrofits and Nature Exposure in K-12 Schools with Imputed Data
TTestS3_complete_P <- t.test(m_data_wide_6_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(TTestS3_complete_P)
```

## Cohen's D

```{r}
function_get_d_data <- function(df, scenario = NA, group = NA) {
  data <- data.frame(scenario = scenario,
                     group = group,
                     d = df$estimate,
                     lower = df$conf.int[1],
                     upper = df$conf.int[2],
                     magnitude = df$magnitude)
  return(data)
}

```


### Using Raw data
```{r}
#install.packages("devtools")
#install.packages("effsize")
#compute Effect Size using Cohen's D
library(effsize)

## Scenario 1: Energy Efficiency Retrofits in K-12 Schools 
print('Scenario 1')
d1_raw <- cohen.d(m_data_wide_2$Chronic_Absenteeism_raw.x, m_data_wide_2$Chronic_Absenteeism_raw.y)


## Scenario 2: Nature Exposure in K-12 Schools 
print('Scenario 2')
d2_raw <- cohen.d(m_data_wide_4$Chronic_Absenteeism_raw.x, m_data_wide_4$Chronic_Absenteeism_raw.y)


## Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools 
print('Scenario 3')
d3_raw <- cohen.d(m_data_wide_6$Chronic_Absenteeism_raw.x, m_data_wide_6$Chronic_Absenteeism.y)
d3_raw
es3_raw <- d3_raw$estimate

```


### Using Imputed Dataset
```{r}
library(effsize)

## Scenario 1: Energy Efficiency in K-12 Schools with Imputed Data
EffSizeS1_complete <- cohen.d(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete)

## Scenario 1L: Lighting in K-12 Schools with Imputed Data
EffSizeS1_complete_L <- cohen.d(m_data_wide_2_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_L)


## Scenario 1H: HVAC in K-12 Schools with Imputed Data
EffSizeS1_complete_H <- cohen.d(m_data_wide_2_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_H)


## Scenario 1B: Building Envelope in K-12 Schools with Imputed Data
EffSizeS1_complete_B <- cohen.d(m_data_wide_2_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_B)


## Scenario 1P: Pumps, Motors and Drives in K-12 Schools with Imputed Data
EffSizeS1_complete_P <- cohen.d(m_data_wide_2_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_2_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS1_complete_P)

## Scenario 2: Nature Exposure in K-12 Schools with Imputed Data
EffSizeS2_complete <- cohen.d(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS2_complete)

## Scenario 3: Energy Efficiency and Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete <- cohen.d(m_data_wide_6_complete$Chronic_Absenteeism_raw.x, m_data_wide_6_complete$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete)

## Scenario 3L: Lighting Retrofits and Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_L <- cohen.d(m_data_wide_6_complete_L$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_L$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_L)

## Scenario 3H: HVAC Retrofits and Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_H <- cohen.d(m_data_wide_6_complete_H$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_H$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_H)


## Scenario 3B: Building Envelope Retrofits and Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_B <- cohen.d(m_data_wide_6_complete_B$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_B$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_B)

## Scenario 3P: Pumps, Motors, & Drives Retrofits and Nature Exposure in K-12 Schools with Imputed Data
EffSizeS3_complete_P <- cohen.d(m_data_wide_6_complete_P$Chronic_Absenteeism_raw.x, m_data_wide_6_complete_P$Chronic_Absenteeism_raw.y, paired = TRUE, conf.level = 0.95)
print(EffSizeS3_complete_P)
```

```{r}
## Scenario 1: Energy Efficiency Retrofits in K-12 Schools with Imputed Dataset
cat('\n Scenario 1 ------ \n')
d1_imp <- cohen.d(m_data_wide_2_complete$Chronic_Absenteeism_raw.x, m_data_wide_2_complete$Chronic_Absenteeism_raw.y)
d1_imp

## Scenario 2: Nature Exposure in K-12 Schools with Imputed Dataset
cat('\n Scenario 2 ------ \n')
d2_imp <- cohen.d(m_data_wide_4_complete$Chronic_Absenteeism_raw.x, m_data_wide_4_complete$Chronic_Absenteeism_raw.y)

## Scenario 3: Energy Efficiency Retrofits and Nature Exposure in K-12 Schools  with Imputed Dataset
cat('\n Scenario 3 ------ \n')
d3_imp <- cohen.d(m_data_wide_6_complete$Chronic_Absenteeism_raw.x, m_data_wide_6_complete$Chronic_Absenteeism_raw.y)
```


### Plot Cohen's d
```{r}
d_data <- rbind(
  function_get_d_data(d1_raw, scenario = 'Scenario 1', group = 'Raw'),
  function_get_d_data(d2_raw, scenario = 'Scenario 2', group = 'Raw'),
  function_get_d_data(d3_raw, scenario = 'Scenario 3', group = 'Raw'),
  function_get_d_data(d1_imp, scenario = 'Scenario 1', group = 'Imputed'),
  function_get_d_data(d2_imp, scenario = 'Scenario 2', group = 'Imputed'),
  function_get_d_data(d3_imp, scenario = 'Scenario 3', group = 'Imputed')
)


## plot
d_data %>%
  ggplot(., aes(x = scenario, y = d, color = group, group = group)) +
  geom_point(size = 3, 
             position = position_dodge(width = 0.3)) +  
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2, 
                position = position_dodge(width = 0.3)) +  
  geom_text(aes(label = round(d, digits = 2)), 
            position = position_dodge(width = 0.3), show.legend = F,
            vjust = 0.5, # Vertical adjustment to avoid overlap
            hjust = -0.5) + # Center the text horizontally relative to the point
  theme_bw() +  # Use a minimal theme
  labs(x = "",
       y = "Cohen's d",
       title = "Comparison of 3 Scenarios' Effect Sizes on Chronic Absenteeism \nin K-12 Schools Across California, USA during the COVID-19 Pandemic") + 
  theme(plot.title = element_text(hjust = 0.5)) + # Center ggplot title) +
  theme(plot.title = element_text(size = 10)) +
  theme(legend.position = c(0.90, 0.15),
        legend.title=element_blank()) 

ggsave(filename = './figures/effect_size_by_scenarios.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```


## Graph Effect Size
```{r}

library(ggplot2)

#' Standardized Mean Difference (Cohen's d)
#' Here we use the effect size in scenario 3, a combined effect of 
#'  Energy Efficiency Retrofits and Nature Exposure
ES <- round(es3_raw, digits = 2) 


#' get mean2 depending on value of ES from 
#'  d = (u1 - u2)/sd
#'  es = (mean1 - mean2)/sd
mean_c <- mean(m_data_wide_6$Chronic_Absenteeism.x, na.rm = T)
mean2 = mean_c 


sd <- 1
mean1 <- ES*sd + mean2

# create x sequence
x <- seq(mean2 - 3*sd, mean1 + 3*sd, .01)

# generate normal dist #1
y1 <- dnorm(x, mean2, sd)
# put in data frame
df1 <- data.frame("x" = x, "y" = y1)

# generate normal dist #2
y2 <- dnorm(x, mean1, sd)
# put in data frame
df2 <- data.frame("x" = x, "y" = y2)

# get y values under overlap
y.poly <- pmin(y1,y2)
# put in data frame
poly <- data.frame("x" = x, "y" = y.poly)

#plot with ggplot2
ggplot(df1, aes(x,y, color="control")) + 
  geom_line(linewidth=1) +
  geom_line(data=df2, aes(color="treatment"),linewidth=1) +
  geom_vline(xintercept = mean1, linetype="dotted") + 
  geom_polygon(aes(color=NULL), data=poly, fill="red", alpha=I(4/10),
               show.legend = F) +
  geom_vline(xintercept = mean2, linetype="dotted") +
  geom_vline(xintercept = mean1, linetype="dotted", color = 'red') +  
  ggtitle(paste0(
    "Scenario 3: Impact of Energy Efficiency Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools",
    "\nCohen's d = ",  ES, ' (Large Effect)')) +
  # # change colors and legend annotation
  scale_color_manual("Group",
            values= c("treatment" = "red","control" = "black")) + 
  annotate(geom = "text", x = round(mean2, 2), y = 0.35, label = round(mean2, 2), hjust = "left") +
  annotate(geom = "text", x = round(mean1, 2), y = 0.35, label = round(mean1, 2), hjust = "left", color = 'red') +
  # # remove axis labels
  ylab("Mean") + xlab("Standard Deviation (σ)") +
  theme_bw()+
  theme(legend.position = c(0.90, 0.85), 
        text = element_text(size = 11),
        plot.title = element_text(size=9))

ggsave(filename = './figures/effect_size.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300)
```

# Calculate and plot a Pearson Correlation Coefficient Matrix 
```{r}
library(readr)
library(readxl)
library(dplyr)
library(tidyverse) 
#Store raw data into a new dataframe
CASchools_Data_income_sub <- read_csv("./data/CASchools_Data_income_subset.csv", show_col_types = FALSE)

#Install then load package to plot PC matrix 
# install.packages("corrplot")
library(corrplot)

names(CASchools_Data_income_sub)
my_data <- CASchools_Data_income_sub %>%
  dplyr::select(NDVI_median:retrofit_and_ndvi)

correlation_matrix = cor(my_data)
corrplot(correlation_matrix, method = "ellipse", order = 'AOE', type = 'lower', tl.col = 'black', diag = F)

f <- paste0('./figures/', 'Pearson_Correlation_Matrix2.png'); print(f)
png(filename = f, width = 7, height = 7, units = "in", res = 300)
corrplot(correlation_matrix, method = "ellipse", order = 'AOE', type = 'lower', tl.col = 'black', diag = F)
dev.off()
```

```{r}
#Plot significant correlations of variables

# install.packages("lares")
library(lares)
p <- corr_cross(my_data, # name of dataframe
  max_pvalue = 0.05, # display only significant correlations (at 5% level)
  top = 10 # display top 10 couples of variables (by correlation coefficient)
   # Call the recordPlot() function to record the plot
)
print(p)
ggsave(filename = './figures/', 'Correlation_Plot.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300, bg="white")

p2 <- corr_var(my_data, # name of dataframe
  Chronic_Absenteeism, # name of variable to focus on
  top = 5 # display top 5 correlations
)
print(p2)
ggsave(filename = './figures/', 'Correlation_Plot_2.png', plot = last_plot(), width = 7, height = 4, units = "in", dpi = 300, bg="white")
```


# Treatment Count for 3 Policy Interventions
```{r}
# Number of Pairs-Matched for K-12 Schools in each policy intervention/scenario 

## Using Raw Data

### Scenario 1
length(unique(m_data_wide_2$subclass))

### Scenario 2
length(unique(m_data_wide_4$subclass))

### Scenario 3
length(unique(m_data_wide_6$subclass))


## -----------------------------------------------------------------


## Using Imputed Data

### Scenario 1
length(unique(m_data_wide_2_complete$subclass))

### Scenario 1L
length(unique(m_data_wide_2_complete_L$subclass))

### Scenario 1H
length(unique(m_data_wide_2_complete_H$subclass))

### Scenario 1B
length(unique(m_data_wide_2_complete_B$subclass))

### Scenario 1P
length(unique(m_data_wide_2_complete_P$subclass))

### Scenario 2
length(unique(m_data_wide_4_complete$subclass))

### Scenario 3
length(unique(m_data_wide_6_complete$subclass))

### Scenario 3L
length(unique(m_data_wide_6_complete_L$subclass))

### Scenario 3H
length(unique(m_data_wide_6_complete_H$subclass))

### Scenario 3B
length(unique(m_data_wide_6_complete_B$subclass))

### Scenario 3P
length(unique(m_data_wide_6_complete_P$subclass))
```

# Statistical Power Analysis 
```{r}
#install.packages("pwr")
library(pwr)
library(ggplot2)

## figure para
w = 6.5
h = 6

## Scenario 1: Energy Efficiency Retrofits on Chronic absenteeism
power.analysis <- pwr.t.test(n = NULL, d = -0.12, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 1:", 
       subtitle = "The Impact of Energy Efficiency Retrofits on Chronic Absenteeism in K-12 Schools",
       x = "Sample Size", y = "P-value", 
       color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('./figures/', 'PowerAnalysis_EERetrofits.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 2: Nature Exposure on Chronic absenteeism
power.analysis <- pwr.t.test(n = NULL, d = 0.41, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  theme_bw() + 
labs(title = "Statistical Power - Scenario 2: ",
     subtitle = "The Impact of Nature Exposure on Chronic Absenteeism in K-12 Schools", 
     x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('./figures/', 'PowerAnalysis_NatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3L: Lighting  Retrofits and Nature Exposure on Chronic absenteeism
power.analysis <- pwr.t.test(n = NULL, d = 0.41, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  
  theme_bw() + 
  labs(title = "Statistical Power - Scenario 3:",
       subtitle = " The Impact of Lighting Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
       x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('./figures/', 'PowerAnalysis_LightingRetrofitsandNatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)


## Scenario 3H: HVAC  Retrofits and Nature Exposure on Chronic absenteeism
power.analysis <- pwr.t.test(n = NULL, d = 0.39, sig.level = 0.05, power = 0.8, alternative = "two.sided") 
plot(power.analysis) +  theme_bw() + 
labs(title = "Statistical Power - Scenario 3: ",
     subtitle = "The Impact of HVAC Retrofits and Nature Exposure on Chronic Absenteeism in K-12 Schools", 
     x = "Sample Size", y = "P-value", color = "Effect Size") + 
  theme(
    plot.title = element_text(size=8, face = 'bold'), 
    plot.subtitle =  element_text(size=8))  # Center ggplot title
ggsave(filename = paste0('./figures/', 'PowerAnalysis_HVACRetrofitsandNatureExposure.png'), plot = last_plot(), width = w, height = h, units = "in", dpi = 300)
```

# View Session Information
```{r}
#To print the version information about R, the Operating System, and attached or loaded packages, use the sessionInfo() function. 
sessionInfo()
```
